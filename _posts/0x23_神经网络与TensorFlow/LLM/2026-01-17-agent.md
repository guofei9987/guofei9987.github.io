---
layout: post
title: ğŸ”¥ã€Agentã€‘åº”ç”¨å…¨æµç¨‹
categories:
tags: 0x23_æ·±åº¦å­¦ä¹ 
keywords:
description:
order: 250
---



## å‰ç½®çŸ¥è¯†


ç›¸å…³èµ„æ–™
- [ã€LLMã€‘æé—®çš„è‰ºæœ¯ï¼šå¦‚ä½•å†™å¥½prompt](https://www.guofei.site/2023/05/13/prompt.html)
- [ã€Transformerã€‘Bertå’ŒGPT](https://www.guofei.site/2022/10/29/transformer.html)
- DNNè®­ç»ƒ
    - [https://www.guofei.site/2019/05/04/dnn_train.html](https://www.guofei.site/2019/05/04/dnn_train.html)
    - [https://www.guofei.site/2017/04/01/DNN.html](https://www.guofei.site/2017/04/01/DNN.html)
    - [https://www.guofei.site/2019/05/12/structuring_ml_projects.html](https://www.guofei.site/2019/05/12/structuring_ml_projects.html)



tokenizer å’Œ embeddingï¼Œä¸ä¼ ç»Ÿç±»ä¼¼

tokenï¼šæ–‡æœ¬åˆ‡åˆ†åçš„â€œæœ€å°å•ä½â€ï¼Œ
- ä¸­æ–‡ï¼šå¹³å‡ä¸€ä¸ªæ±‰å­—ä¸€ä¸ª tokenï¼Œæœ‰å¤šä¸ªæ±‰å­—åˆå¹¶ä¸ºä¸€ä¸ª token çš„æƒ…å†µï¼Œä¹Ÿæœ‰1ä¸ªç”Ÿåƒ»å­—æ‹†åˆ†æˆå¤šä¸ª token çš„æƒ…å†µ
- è‹±æ–‡ï¼š1ä¸ªtoken=3ï½4ä¸ªå­—ç¬¦ï¼Œå› æ­¤ä¸€ä¸ªå•è¯å¹³å‡ 1ï½2ä¸ª tokenï¼ˆé•¿è¯ä¼šæ›´å¤šï¼‰

ä¸€ä¸ªå±•ç¤ºtokençš„ç½‘ç«™ï¼šhttp://tiktokenizer.vercel.app/


embeddingï¼šæ¯ä¸ªtokenå¯¹åº”çš„å‘é‡ï¼Œå¯èƒ½æ˜¯ 768ã€2048ã€4096 ç­‰ï¼Œå–å†³äºæ¨¡å‹ï¼Œä¹Ÿæ˜¯æ¨¡å‹è®­ç»ƒæ—¶ï¼Œéœ€è¦æ›´æ–°çš„å‚æ•°ã€‚


ä¸€ä¸ª GPT æ¨¡å‹å¯è§†åŒ–çš„ç½‘ç«™ï¼šhttps://bbycroft.net/llm

## Prompt


å¥½çš„é—®é¢˜æ‰æœ‰å¥½çš„ç­”æ¡ˆï¼ˆå¦ä¸€ç¯‡åšå®¢ï¼‰

å®é™…ä¸Šï¼ŒRAGã€Zero Shotã€One Shotã€Few Shot éƒ½å±äº Prompt


## OpenAI

æ¨¡å‹çš„è°ƒç”¨æ–¹å¼å¾ˆå¤šï¼Œä¾‹å¦‚ç”¨ `request` è°ƒç”¨ã€‚å¤§å¤šæ•°å¯ä»¥ç”¨ `OpenAI` æ–¹å¼è°ƒç”¨


```python
# pip install openai
from openai import OpenAI

client = OpenAI(
    api_key="xxx",
    base_url="https://xxx.xxx.com/v1/"
    # æ³¨æ„ base_url ä¸è¦åŠ  chat/completions
)

# %% ç®€å•è°ƒç”¨
resp = client.chat.completions.create(
    model="DeepSeek-V3.2",
    messages=[
        {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªç®€æ´çš„åŠ©æ‰‹ã€‚"},
        {"role": "user", "content": "ç”¨ä¸€å¥è¯è§£é‡Šä»€ä¹ˆæ˜¯YOLOæ ‡æ³¨æ ¼å¼ã€‚"},
    ],
)

print(resp.choices[0].message.content)

# %% æµå¼è¾“å‡º
stream = client.chat.completions.create(
    model="DeepSeek-V3.2",
    messages=[{"role": "user", "content": "å†™ä¸€ä¸ªPythonå‡½æ•°ï¼Œåˆ¤æ–­ç´ æ•°ã€‚"}],
    stream=True,
)

for chunk in stream:
    delta = chunk.choices[0].delta
    if delta and delta.content:
        print(delta.content, end="", flush=True)
print()

# %% å¤šæ¨¡æ€
import base64


def b64_image(path):
    return base64.b64encode(open(path, "rb").read()).decode()


resp = client.chat.completions.create(
    model="Qwen3-VL-32B-Instruct",
    messages=[{
        "role": "user",
        "content": [
            {"type": "text", "text": "è¿™å¼ å›¾é‡Œæœ‰ä»€ä¹ˆï¼Ÿ"},
            {"type": "image_url", "image_url": {"url": f"data:image/png;base64,{b64_image('1.png')}"}},
            # {"type": "image_url", "image_url": {"url": "https://xxx/1.png"}},
        ],
    }],
)

print(resp.choices[0].message.content)

#%% embedding

resp = client.embeddings.create(
    model="Qwen3-Embedding-0.6B",
    input=[
        "å¤–å–ä¸å¥½åƒ",
        "é€çš„å¾ˆå¿«",
        "å¤ªæ²¹äº†ï¼Œå¤ªè¾£äº†"
    ],
)

# æ¯ä¸€æ¡å¯¹åº” resp.data çš„ä¸€æ¡
vec0 = resp.data[0].embedding  # list<float>
```


## MCP

LLM è°ƒç”¨å·¥å…·ï¼Œæœ‰ä¸€æ®µæ¼”åŒ–å†å²
- ç¬¬ä¸€ä»£ï¼Œç”± OpenAI è°ƒç”¨å„ç§å·¥å…·ã€‚å…·ä½“åšæ³•æ˜¯ï¼šå·¥å…·å¼€å‘è€…ä¸Šä¼ ä¸€ä¸ª yml æ–‡ä»¶ï¼Œymlå†™æ˜ descriptionã€è°ƒç”¨æ–¹æ³•ç­‰ï¼Œç”¨æˆ·ä½¿ç”¨çš„æ—¶å€™æœ€å¤šæ‰‹åŠ¨é€‰æ‹©3ä¸ª tool
- ç¬¬äºŒä»£ï¼Œç”±åº”ç”¨è°ƒç”¨ LLMï¼Œç„¶å LLM å†³å®šè°ƒç”¨å“ªä¸ªå‡½æ•°ï¼Œåº”ç”¨å»è°ƒç”¨è¿™ä¸ªå‡½æ•°
- ç¬¬ä¸‰ä»£ï¼Œæ¨¡ç‰ˆç”Ÿæˆ promptï¼Œå¯¹ LLM åš SFTï¼Œä½¿å…¶æœ‰è°ƒç”¨èƒ½åŠ›

MCPï¼ˆModel Context Protocolï¼‰ åè®®æ˜¯ Claude æ¯å…¬å¸ Anthropic äº 2024å¹´11æœˆå¼€æºå‘å¸ƒï¼Œå®ƒæä¾›äº†ä¸€ç§æ ‡å‡†åŒ–æ–¹å¼è¿æ¥ä¸åŒçš„ LLMã€å·¥å…·


ä¸€äº› MCP å¸‚åœº
- mcp.so
- mcpmarket.com
- smithery.ai


MCP åŸç†


<div class="mermaid">
sequenceDiagram
    autonumber
    participant ç”¨æˆ·
    participant Cline
    participant MCP Server
    participant LLM

    rect rgb(240, 248, 255)
    Note over Cline,MCP Server: å¯åŠ¨ï¼ˆåªè¿è¡Œä¸€æ¬¡ï¼‰
    Cline ->> MCP Server: å¯åŠ¨ MCP Server
    Cline ->> MCP Server: ä½ å¥½ï¼Œæˆ‘æ˜¯ Cline
    MCP Server -->> Cline: ä½ å¥½ï¼Œæˆ‘æ˜¯ get_info
    Cline ->> MCP Server: ä½ æœ‰å“ªäº›å·¥å…·ï¼Ÿ
    MCP Server -->> Cline: æˆ‘æœ‰ get_my_info,...
    end

    loop æ¯æ¬¡ç”¨æˆ·æé—®ï¼ˆå¯åå¤è¿è¡Œï¼‰
    ç”¨æˆ· ->> Cline: Guo Fei çš„ GitHub åœ°å€æ˜¯ï¼Ÿ
    Cline ->> LLM: Guo Fei çš„ GitHub åœ°å€æ˜¯ï¼Ÿæˆ‘è¿˜æœ‰ä¸€äº›å·¥å…·...
    LLM -->> Cline: æˆ‘è¦è°ƒç”¨ get_my_infoï¼Œå‚æ•°æ˜¯...
    Cline ->> MCP Server: æˆ‘è¦è°ƒç”¨ get_my_infoï¼Œå‚æ•°æ˜¯...
    MCP Server -->> Cline: è°ƒç”¨å®Œæ¯•ï¼Œç»“æœæ˜¯xxx
    Cline ->> LLM: è°ƒç”¨å®Œæ¯•ï¼Œç»“æœæ˜¯xxx
    LLM -->> Cline: Guofei çš„ Github åœ°å€æ˜¯xxx
    Cline -->> ç”¨æˆ·: Guofei çš„ Github åœ°å€æ˜¯xxx
    end
</div>


æ³¨
1. Cline å¯ä»¥æ¢æˆåˆ«çš„ï¼Œä¾‹å¦‚ Codex
2. Cline å’Œ MCP Server ä¹‹é—´çš„å¯¹è¯éƒ½æ˜¯ XML/Json æ ¼å¼çš„ï¼Œä¸Šé¢çš„å›¾ä¸ºäº†å¥½ç†è§£æ‰å†™æˆè‡ªç„¶è¯­è¨€
3. MCP åè®®æœ¬èº«å¹¶æ²¡æœ‰è§„å®šå¦‚ä½•ä¸ LLM äº¤äº’ï¼Œä¸ LLM äº¤äº’æ˜¯ç”± Cline å†³å®šçš„ã€‚Cline è°ƒç”¨ LLM çš„ Prompt æå…¶å¤æ‚ï¼ˆå‡ ä¸‡å­—ï¼‰ï¼ŒåŒ…å« tool ç”¨æ³•ã€å„ç§æŒ‡ä»¤ï¼ˆ XMLã€Function Calling ä¹‹ç±»çš„ï¼‰
    - Cline ä¸ LLM çš„äº¤äº’å¯èƒ½ä¸ºå¤šè½®ï¼Œç›´åˆ°å¾—åˆ°æœ€ç»ˆç»“æœ
    - è¿™ä¸ªå¤šè½®äº¤äº’ï¼Œå¯ä»¥æŠ½è±¡ä¸º **æ€è€ƒ-è¡ŒåŠ¨-è§‚å¯Ÿ**ï¼ˆThink-Action-Observationï¼‰çš„å¾ªç¯ï¼Œå¹¶æœ€ç»ˆç”¨ä¸€ä¸ªç»“æŸæ ‡å¿—ï¼ˆæœ¬èº«æ˜¯ä¸€ä¸ª Actionï¼‰æ¥ç»“æŸæ•´ä¸ªæµç¨‹ã€‚è¿™ä¸ªæ€æƒ³å‡ºè‡ª **ReAct**ï¼ˆ2022å¹´çš„ä¸€ç¯‡è®ºæ–‡ï¼‰
    - æ¯æ¬¡äº¤äº’ï¼Œæœ¬èº«ä¹Ÿæ˜¯ stream æ¨¡å‹ï¼ŒLLM ä¼šè¿ç»­åå‡º Token



### MCP å®æ“


**step1ï¼šç¯å¢ƒé…ç½®**
```bash
# åˆ›å»º MCP é¡¹ç›®
mkdir my_mcp
cd my_mcp

# å»ºç«‹è™šæ‹Ÿç¯å¢ƒ
python3 -m venv .venv
source .venv/bin/activate
python -m pip install -U pip
pip install "mcp[cli]"

# ä¸è¦æ‰‹åŠ¨è¿è¡Œï¼Œä»…ä½œä¸ºæµ‹è¯•ä½¿ç”¨
# python server.py
```

**step2:å†™ä»£ç ** ä¿å­˜ä¸º `server.py`ï¼ˆåˆ«çš„åå­—ä¹Ÿå¯ä»¥ï¼Œä¹‹åçš„é…ç½®æŒ‰ç…§å®é™…åå­—æ›´æ”¹ï¼‰

```python
from mcp.server.fastmcp import FastMCP

mcp = FastMCP("get_info", log_level="ERROR")


@mcp.tool()
async def get_my_info(channel: str) -> str:
    # ä¸‹é¢çš„å‡½æ•°æ³¨é‡Šä¼šå…ˆè¢« LLM æ‹¿åˆ°
    """
    Get Guo Fei's public information by channel.

    Available channels (must match exactly):
    - "ä¸ªäººç½‘ç«™": personal website
    - "GitHub": GitHub profile
    - "çŸ¥ä¹": Zhihu profile

    Args:
        channel: One of the predefined channel names above.

    Returns:
        A URL string corresponding to the requested channel.

    If an invalid channel is provided, a readable error message is returned.
    """

    info = {
        "ä¸ªäººç½‘ç«™": "https://www.guofei.site/"
        , "GitHub": "https://github.com/guofei9987/"
        , "çŸ¥ä¹": "https://www.zhihu.com/people/guofei9987/answers/by_votes"
    }

    return info.get(channel, f"æ— æ•ˆçš„æ¸ é“åç§°ï¼š{channel}ã€‚è¯·ä½¿ç”¨ä»¥ä¸‹ä¹‹ä¸€ï¼š{', '.join(info.keys())}")


if __name__ == "__main__":
    mcp.run(transport='stdio')
```



**step3:é…ç½®å·¥å…·**ï¼šï¼ˆç”¨ CLINEï¼‰ã€‚
- åœ¨ VSCode ä¸­ï¼Œå®‰è£… CLINE
- åœ¨ CLINE ä¸­ï¼Œé…ç½® MCP
- é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼šï¼ˆæ³¨æ„ï¼Œåœ°å€æŒ‰ç…§å®é™…åœ°å€æ›´æ”¹ï¼Œæœ€å¥½æ˜¯ç»å¯¹è·¯å¾„ï¼‰
```json
"get_my_info": {
      "autoApprove": [],
      "disabled": false,
      "timeout": 60,
      "command": "ï½/my_mcp/.venv/bin/python",
      "args": [
        "ï½/my_mcp/server.py"
      ],
      "type": "stdio"
    }
```


**step4ï¼šä½¿ç”¨ agent**
- è¾“å…¥æµ‹è¯•è¯­å¥ï¼š`è°ƒç”¨ get-my-info å·¥å…·ï¼Œchannel = github`
- agent è¿”å›çš„è¾“å‡ºï¼š`æˆåŠŸè°ƒç”¨ get-my-info å·¥å…·ï¼Œchannel = githubï¼Œè¿”å›ç»“æœä¸ºï¼š[](https://github.com/guofei9987/)<https://github.com/guofei9987/>`



**step3-1:åˆ«çš„å·¥å…·ä¹Ÿå¯ä»¥**
- Codexï¼šé…ç½®æ–‡ä»¶æ˜¯è¿™æ ·çš„ï¼š
```
[mcp_servers.get_my_info]
command = "~/my_mcp/.venv/bin/python"
args = ["~/my_mcp/server.py"]
```


**step4_1:ä½¿ç”¨**
- è¾“å…¥ï¼š`Guo Fei çš„ GitHub åœ°å€æ˜¯ï¼Ÿ`
- è¾“å‡ºï¼š`Guo Fei çš„ GitHub åœ°å€æ˜¯ https://github.com/guofei9987/`







## RAG

**ä¸ºä»€ä¹ˆéœ€è¦ RAGï¼Ÿ** Prompt è§£å†³ä¸äº†çš„é—®é¢˜ï¼š
- ç¼ºä¹çŸ¥è¯†ï¼šæ¶‰åŠæœ€æ–°çš„çŸ¥è¯†ï¼ˆä¾‹å¦‚æŸä¸ªæ–°ä¸Šæ˜ çš„ç”µå½±ï¼‰ï¼Œæˆ–è€…ç‰¹å®šä¸“ä¸šçŸ¥è¯†ï¼ˆä¾‹å¦‚å†…ç½‘çš„æŸä¸ªåŠå…¬åº”ç”¨å¦‚ä½•é…ç½®ï¼‰ï¼Œå¤§æ¨¡å‹æ²¡æœ‰å­¦ä¹ è¿‡ï¼Œæ‰€ä»¥è¡¨ç°ä¸å¥½
- å¹»è§‰é—®é¢˜ï¼šå¤§æ¨¡å‹ä¸äº†è§£è‡ªå·±çš„çŸ¥è¯†è¾¹ç•Œï¼Œå¯¹äºæ¬ ç¼ºçŸ¥è¯†çš„é¢†åŸŸä»ç„¶å°è¯•å›ç­”ï¼Œé”™è¯¯çš„å›ç­”å†…å®¹å…·æœ‰è¿·æƒ‘æ€§


è§£å†³æ–¹æ¡ˆï¼š**RAG**ï¼ˆRetrieval-Augmented Generationï¼Œæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰
- æœ¬è´¨ä¸Šå°±æ˜¯æŠŠæœç´¢åˆ°çš„èµ„æ–™ï¼ˆä¾‹å¦‚ä¼ä¸šä¿¡æ¯ã€çŸ¥è¯†åº“ç­‰ï¼‰ä½œä¸ºæç¤ºè¯çš„ä¸€éƒ¨åˆ†å‘ç»™ LLMï¼Œè®© LLM æœ‰æ ¹æ®åœ°è¾“å‡ºå†…å®¹ï¼Œä»è€Œæé«˜å›ç­”çš„å‡†ç¡®æ€§ã€ç›¸å…³æ€§ã€æ–°é²œåº¦ï¼Œå¹¶è§£å†³å¹»è§‰é—®é¢˜ã€‚
    - OpenAIï¼šRAG å¯ä»¥å°†å›ç­”å‡†ç¡®ç‡ä» 45% æå‡åˆ°äº† 98%
- ç›¸å½“äºç»™å¤§æ¨¡å‹è£…ä¸Šäº†â€œçŸ¥è¯†å¤–æŒ‚â€ï¼ŒåŸºç¡€å¤§æ¨¡å‹ä¸ç”¨é‡æ–°è®­ç»ƒå³å¯éšæ—¶è°ƒç”¨ç‰¹å®šé¢†åŸŸçŸ¥è¯†ã€‚çœä¸‹äº†é‡æ–°è®­ç»ƒçš„æˆæœ¬ã€‚
- æŠ€æœ¯å®ç°ä¸Šï¼Œæ¶‰åŠæ•°æ®æ£€ç´¢ã€ä¿¡æ¯å¢å¼ºã€AI ç”Ÿæˆç­‰å¤šä¸ªè¿‡ç¨‹


**RAGæ­¥éª¤**
- å‡†å¤‡é˜¶æ®µ
    - **æ–‡æ¡£ç»“æ„åŒ–**ï¼ŒæŠŠ jsonã€pdfã€htmlã€å›¾ç‰‡ç­‰ç­‰ï¼Œè½¬åŒ–ä¸º txt
    - **åˆ†å—**ï¼ˆChunkingï¼‰ï¼ŒæŠŠæ–‡æ¡£åˆ‡åˆ†ä¸ºå°å—
        - å¸¸è§æ–¹æ³•
            - å›ºå®šåˆ†å—ï¼šæ¯ä¸ªåˆ†å—512ä¸ªï¼Œè¦æœ‰é‡å ï¼ˆoverlappingï¼‰
            - å›ºå®šè§„åˆ™ï¼šä¾‹å¦‚ç”¨æ ‡ç‚¹ã€æ®µè½åˆ†å—
            - è¯­ä¹‰åˆ†å—ï¼šä½¿ç”¨æ–‡æœ¬ç±»æ¨¡å‹åšåŒºå—è¯†åˆ«
        - åˆ†å—åŸåˆ™
            - å°½å¯èƒ½ä¿ç•™å…³é”®ä¿¡æ¯
            - æ•ˆæœè¯„ä¼°ï¼šåé¢
    - **Embedding**ï¼ŒæŠŠå°å—æ˜ å°„ä¸ºå‘é‡ï¼Œå¯ä»¥æé«˜æ£€ç´¢æ€§èƒ½
    - **æ„å»ºç´¢å¼•**ï¼ˆIndexingï¼‰ ï¼ŒæŠŠè¿™äº›å‘é‡å­˜åˆ°å‘é‡æ•°æ®åº“/ç´¢å¼•ã€‚ä¸€äº›ä¼˜åŒ–ç­–ç•¥
        - æ ¹æ®æ‰©å±•ä¿¡æ¯ï¼Œå¦‚æ ‡ç­¾ã€æ‘˜è¦ã€å…³è”é—®é¢˜
        - é“¾å¼ç´¢å¼•ã€æ ‘ç´¢å¼•ã€å›¾ç´¢å¼•
- è°ƒç”¨é˜¶æ®µ
    - **Query Rewrite**ï¼šæŠŠç”¨æˆ·é—®é¢˜æ”¹å†™ä¸ºåˆé€‚æ£€ç´¢çš„é—®é¢˜
        - ä¾‹å¦‚ï¼Œç”¨æˆ·é—®â€œiPhone15 Pro å’Œ iPhone16 å“ªä¸ªç»­èˆªé•¿â€ï¼Œå°±éœ€è¦æ‹†åˆ†æˆä¸¤ä¸ªé—®é¢˜å»æ£€ç´¢
        - åˆä¾‹å¦‚ï¼Œé”™åˆ«å­—ã€ä¸é€šé¡ºçš„è¡¨è¾¾ã€æŒ‡ä»£ä¸æ˜ã€ç©æ¢—ç­‰
        - *å¯é€‰*ï¼šè¯­ä¹‰æ ¡éªŒæ¨¡å—ï¼Œç”¨æ¥åˆ¤æ–­æ”¹å†™çš„è´¨é‡
    - **æ£€ç´¢**ï¼ˆRetrievalï¼‰ï¼šå„ç§æ£€ç´¢
    - **é‡æ’**ï¼ˆRerankï¼‰ï¼šç›®çš„æ˜¯æå‡æ£€ç´¢ç²¾åº¦ã€ç²¾ç®€åç»­å¯¹æ¨¡å‹çš„è¾“å…¥
        - å¸¸è§æ–¹æ³•ï¼šç”¨æ¨¡å‹é‡æ’ã€ç»“åˆä¸šåŠ¡ç­–ç•¥ï¼ˆæ—¶é—´ã€ç”¨æˆ·å±æ€§ã€æ ‡ç­¾ç­‰ï¼‰
    - **Promptå·¥ç¨‹**ï¼ˆæ ¸å¿ƒæŠ€æœ¯ï¼‰ï¼Œå¦‚ä½•æŠŠæ£€ç´¢ç»“æœå¾ˆå¥½çš„æ”¾å…¥ Prompt
    - å¤§æ¨¡å‹æ ¹æ® Prompt åšå‡ºå›ç­”


åŠ å…¥åˆ° Prompt æ˜¯è¿™æ ·çš„ï¼š

```text
"""
åŸºäºæä¾›çš„ã€ç›¸å…³ææ–™ã€‘ï¼Œå›ç­”æœ€åçš„é—®é¢˜
## ã€ç›¸å…³ææ–™ã€‘
{context}

## æœ€åçš„é—®é¢˜
é—®é¢˜ï¼š{input}
"""
```

**RAG çš„æ•ˆæœè¯„ä¼°**ï¼Œè¯„ä¼°å·¥å…·ï¼š[RAGAS](https://zhuanlan.zhihu.com/p/1897294443570246229)

- æ£€ç´¢çš„è¯„ä¼°
    - å¬å›ç‡ï¼šæ˜¯å¦æ£€ç´¢å‡ºäº† Top N å†…å®¹
    - ç›¸å…³æ€§ï¼šå¬å›çš„å†…å®¹ä¸ query çš„ç›¸å…³æ€§
    - ä¸šåŠ¡ç»´åº¦ï¼šä¾‹å¦‚åœ°åŸŸã€æ—¶æ•ˆç­‰
- ç”Ÿæˆçš„è¯„ä¼°
    - **faithful** å¿ å®æ€§ï¼šç­”æ¡ˆæ˜¯å¦æ˜¯ä»å¬å›çš„å†…å®¹ä¸­æ¨æ–­å‡ºæ¥çš„
    - **answer relevance** ç­”æ¡ˆç›¸å…³æ€§ï¼šå›ç­”å’Œå¬å›å†…å®¹ï¼Œä¸é—®é¢˜çš„ç›¸å…³æ€§
    - **answer similarity** ç­”æ¡ˆç›¸ä¼¼æ€§ï¼šå›ç­”å’Œæ ‡å‡†ç­”æ¡ˆçš„ç›¸ä¼¼æ€§
    - äº‹å®å‡†ç¡®æ€§ï¼šå›ç­”æ˜¯å¦åŒ¹é…ç”¨æˆ·é—®é¢˜
    - ...
- ä¸šåŠ¡æŒ‡æ ‡ï¼šç”¨æˆ·æ»¡æ„ç‡ã€é¦–è½®æˆåŠŸç‡


**RAGä¼˜åŒ–**
1. Chunking é˜¶æ®µï¼šç”¨æ¨¡å‹åŸºäºè¯­ä¹‰åšåˆ‡åˆ†
2. rewrite


### RAG å®æ“

å‡†å¤‡å·¥ä½œä¸è¯´æ˜ï¼š
- å¤§æ¨¡å‹ï¼ˆOpenAI å¯è°ƒç”¨ï¼‰
- ä¸€ä¸ªåŸå§‹æ–‡æ¡£ [prices.txt](http://guofei.site/datasets/nlp/prices.txt)ï¼Œå†…å®¹ç±»ä¼¼ï¼š
```
iPhone 15 Pro Max: 7999å…ƒ
å„¿ç«¥å®‰å…¨åº§æ¤…ï¼š699å…ƒ
...
```
- ç›¸å…³çš„åŒ…å®‰è£…
```sh
pip install -U transformers sentence-transformers
pip install -U langchain langchain-community langchain-huggingface huggingface_hub
# å‘é‡æ•°æ®åº“ï¼š
pip install -U chromadb
pip install -U openai
```
- æ¨¡å‹ä¸‹è½½ï¼ˆä¸ºäº†å±•ç¤ºï¼Œé€‰ç”¨ä¸€äº›è½»é‡çº§çš„æ¨¡å‹ï¼‰
    - å¬å›ï¼šhttps://huggingface.co/BAAI/bge-small-zh-v1.5
    - é‡æ’ï¼šhttps://huggingface.co/cross-encoder/mmarco-mMiniLMv2-L12-H384-v1/



è¯´æ˜ï¼šå„ä¸ªç¯èŠ‚éƒ½æ¯”è¾ƒç²—æš´ï¼Œå®é™…åº”ç”¨å¯ä»¥æŒ‰ç…§ä¸Šé¢çš„ç†è®ºç¯‡å¯¹æ¯ä¸ªç¯èŠ‚ä¼˜åŒ–
- Chunkingï¼Œç®€å•ç”¨æ¢è¡Œç¬¦åˆ†å‰²
- å¬å›æ¨¡å‹ã€é‡æ’æ¨¡å‹ï¼Œéƒ½ç”¨çš„å¾ˆå°çš„æ¨¡å‹
- æ²¡æœ‰åš Query Rewrite


**å…ˆä¸ç”¨ RAG è¯•ä¸€ä¸‹**
```python
query = "iPhone 15 Pro Max å¤šå°‘é’±"


payload = {
    'model': 'DeepSeek-V3.2',
    'messages': [
        {
            'role': 'system',
            'content': 'ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹'
        },
        {
            'role': 'user',
            'content': query
        }
    ],
}

res = call_model(payload)

print("æœªåŠ å…¥ RAGçš„ç»“æœï¼š")
print(res)
```

ç»“æœå°±ä¸è´´äº†ï¼Œåˆé•¿åˆå‡


**ä½¿ç”¨ RAG**

```python
from typing import List

query = "iPhone 15 Pro Max å¤šå°‘é’±"


# %% Chunking
def split_into_chunks(doc_file: str) -> List[str]:
    with open(doc_file, 'r') as f:
        content = f.read()
    return content.split('\n')


chunks = split_into_chunks("ä»·æ ¼è¡¨.txt")

# %% Embedding

from sentence_transformers import SentenceTransformer

embed_model = SentenceTransformer("./bge-small-zh-v1.5")



def embed_chunk(chunk: str) -> List[float]:
    embedding = embed_model.encode(chunk)
    return embedding.tolist()


test_embedding = embed_chunk("æµ‹è¯•")
print("embedding çš„ç»´åº¦", len(test_embedding))

embeddings = [embed_chunk(chunk) for chunk in chunks]

print("embedding æ•°é‡ï¼ˆç‰‡æ®µä¸ªæ•°ï¼‰", len(embeddings))

# %% embedding å­˜å…¥å‘é‡æ•°æ®åº“ä¸­

import chromadb

# æ•°æ®å­˜åœ¨å†…å­˜ä¸­
chromadb_client = chromadb.EphemeralClient()
chromadb_collection = chromadb_client.get_or_create_collection(name="default")


def save_embedding(chunks: List[str], embeddings: List[List[float]]) -> None:
    ids = [str(i) for i in range(len(embeddings))]
    chromadb_collection.add(
        documents=chunks,
        embeddings=embeddings,
        ids=ids
    )


save_embedding(chunks, embeddings)


# %% å¬å›

def retrieve(query: str, top_k: int) -> List[str]:
    query_embedding = embed_chunk(query)
    results = chromadb_collection.query(
        query_embeddings=query_embedding,
        n_results=top_k
    )
    return results['documents'][0]


retrieved_chunks = retrieve(query, 10)

print("å¬å›ï¼š", retrieved_chunks)

# %% é‡æ’
from sentence_transformers import CrossEncoder

cross_encoder = CrossEncoder("./mmarco-mMiniLMv2-L12-H384-v1")


def rerank(query: str, retrieved_chunks: List[str], top_k: int = 3) -> List[str]:
    pairs = [(query, chunk) for chunk in retrieved_chunks]
    scores = cross_encoder.predict(pairs)

    chunk_with_scores = [(chunk, score)
                         for chunk, score in zip(retrieved_chunks, scores)]

    chunk_with_scores.sort(key=lambda x: x[1], reverse=True)

    return [chunk for chunk, _ in chunk_with_scores][:top_k]


reranked_chunks = rerank(query, retrieved_chunks)

print("é‡æ’åï¼š", reranked_chunks)

# %% æµ‹è¯•ç»“æœï¼š

query = "çš®é‹å¤šå°‘é’±"

retrieved_chunks = retrieve(query, top_k=10)
reranked_chunks = rerank(query, retrieved_chunks, top_k=3)

print("query:", query)
print("retrieved_chunks:", retrieved_chunks)
print("reranked_chunks:", reranked_chunks)


from openai import OpenAI

client = OpenAI(
    api_key="xxx",
    base_url="https://xxx.xxx.com/v1/"
)

resp = client.chat.completions.create(
    model="DeepSeek-V3.2",
    messages=[
        {
            'role': 'system',
            'content': f'''ä½ æ˜¯ä¸€ä¸ªåŠ©æ‰‹ï¼Œè¯·ç»™äºˆã€ç›¸å…³ææ–™ã€‘å›ç­”é—®é¢˜
# ã€ç›¸å…³ææ–™ã€‘
{"\n".join(reranked_chunks)}
            '''
        },
        {
            'role': 'user',
            'content': query
        }
    ],
)

print(resp.choices[0].message.content)
```


<!-- å‚è€ƒèµ„æ–™ï¼šhttps://www.douyin.com/video/7523955114718088487 -->

### RAG å·¥ç¨‹é€‰å‹

**æ–‡æ¡£é¢„å¤„ç†**
- PDFï¼šPyMuDPF
- python-docx
- OCRï¼špytesseract
- å›¾åƒ embeddingï¼šCLIPï¼ˆå¯ä»¥åŒæ—¶ç†è§£å›¾ç‰‡å†…å®¹å’Œå›¾ç‰‡ä¸­çš„æ–‡æœ¬ï¼‰
    - é™¤äº†å›¾åƒæœ¬èº«åš embedding ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ç”¨ VL ç”Ÿæˆå›¾åƒçš„æè¿°ï¼ŒæŠŠè¿™æ®µæè¿°ä¹Ÿåš embedding æ”¾å…¥æ•°æ®åº“ä¸­ï¼ˆå‘é‡æ•°æ®åº“ä¸­æœ‰2æ¡è®°å½•ï¼‰
- å¦ä¸€ä¸ªæ€è·¯ï¼ˆæ›´ç°ä»£ï¼Œæ•ˆæœæ›´å¥½ï¼‰ï¼šä½¿ç”¨å¤šæ¨¡ embeddingï¼Œå®ƒå¯ä»¥æŠŠå›¾ç‰‡ã€æ–‡æœ¬ã€è§†é¢‘ç­‰æ˜ å°„åˆ°åŒä¸€ä¸ªå‘é‡ç©ºé—´ä¸­ï¼Œå¯ä»¥å®ç°ä»¥æ–‡æœå›¾ã€ä»¥å›¾æœè§†é¢‘ç­‰
    - Qwen-VL-embedding
    - multimodal-embedding-v1ï¼ˆOpenAIæä¾›çš„é—­æºæ¨¡å‹ï¼‰
    

**åˆ‡ç‰‡ç­–ç•¥** ï¼ˆä¸»è¦å°±æ˜¯å‰2ä¸ªï¼‰
- å›ºå®šé•¿åº¦
- LLM åšåˆ‡ç‰‡ï¼šè´¨é‡é«˜ã€æˆæœ¬é«˜
- å¥å­è¾¹ç•Œ
- æŒ‰æ ‡é¢˜/ç« èŠ‚åˆ‡åˆ†ï¼šmarkdown è¿™ç§é«˜åº¦ç»“æ„åŒ–çš„æ–‡æ¡£
- æ»‘åŠ¨çª—å£

**embedding**
- å‚è€ƒ [https://www.guofei.site/2018/09/24/nlp_feature.html](https://www.guofei.site/2018/09/24/nlp_feature.html) å…³äº embedding çš„éƒ¨åˆ†
- æ¨¡å‹ä¸Šï¼Œå‰é¢çš„ä¾‹å­ç”¨çš„æ˜¯ `sentence_transformers` åŠ è½½ä¸€ä¸ªæ¨¡å‹
- ä¹Ÿå¯ä»¥è°ƒç”¨ Qwen3-embedding æ¨¡å‹ï¼ˆç”¨ openai è°ƒç”¨ï¼‰ï¼Œè¿™äº›æ›´ç°ä»£çš„æ¨¡å‹ä¼šæ›´å‡†
- å¯ä»¥ä» huggingface ä¸Šæ‰¾ï¼Œå›½å†…ï¼šhttps://modelscope.cn/

å¸¸è§æ¨¡å‹
- å¸¸è§çš„é€šç”¨ embedding æ¨¡å‹
    - **BGE-M3** M3ï¼ˆæ™ºæºç ”ç©¶é™¢ï¼‰ï¼šæ”¯æŒ100+è¯­è¨€ï¼Œè¾“å…¥é•¿åº¦è¾¾8192 tokensï¼Œèåˆå¯†é›†ã€ç¨€ç–ã€å¤šå‘é‡æ··åˆæ£€ç´¢ï¼Œé€‚åˆè·¨è¯­è¨€é•¿æ–‡æ¡£æ£€ç´¢ã€‚
    - **text-embedding-3-large**ï¼ˆOpenAIï¼‰ï¼šå‘é‡ç»´åº¦3072ï¼Œé•¿æ–‡æœ¬è¯­ä¹‰æ•æ‰èƒ½åŠ›å¼ºï¼Œè‹±æ–‡è¡¨ç°ä¼˜ç§€ã€‚
    - **Jina-embeddings-v2-small**ï¼ˆJina AIï¼‰ã€‚ç‰¹ç‚¹ï¼šå‚æ•°é‡ä»…35Mï¼Œæ”¯æŒå®æ—¶æ¨ç†ï¼ˆRT<50msï¼‰ï¼Œé€‚åˆè½»é‡åŒ–éƒ¨ç½²ã€‚
- å¸¸è§çš„ä¸­æ–‡ embedding æ¨¡å‹
    - **xiaobu-embedding-v2**ï¼šé’ˆå¯¹ä¸­æ–‡è¯­ä¹‰ä¼˜åŒ–ï¼Œè¯­ä¹‰ç†è§£èƒ½åŠ›å¼ºã€‚
    - **M3E-Base**ï¼šé’ˆå¯¹ä¸­æ–‡ä¼˜åŒ–çš„è½»é‡æ¨¡å‹ï¼Œé€‚åˆæœ¬åœ°ç§æœ‰åŒ–éƒ¨ç½²ã€‚é€‚ç”¨åœºæ™¯ï¼šä¸­æ–‡æ³•å¾‹ã€åŒ»ç–—é¢†åŸŸæ£€ç´¢ä»»åŠ¡ã€‚æ–‡ä»¶å¤§å°ï¼š0.4G ï¼ˆm3e-baseï¼‰
    - **stella-mrl-large-zh-v3.5-1792**ï¼šå¤„ç†å¤§è§„æ¨¡ä¸­æ–‡æ•°æ®èƒ½åŠ›å¼ºï¼Œæ•æ‰ç»†å¾®è¯­ä¹‰å…³ç³»ã€‚é€‚ç”¨åœºæ™¯ï¼šä¸­æ–‡æ–‡æœ¬é«˜çº§è¯­ä¹‰åˆ†æã€è‡ªç„¶è¯­è¨€å¤„ç†ä»»åŠ¡ã€‚






å‘é‡æ•°æ®åº“
- å‰é¢çš„ä¾‹å­ç”¨çš„æ˜¯ Chromaï¼Œå®ƒæ‰“åŒ…äº†â€œå‘é‡+æ–‡æ¡£+å…ƒæ•°æ®+æŒä¹…åŒ–+éƒ¨ç½²æ¨¡å¼â€ï¼Œé€‚åˆå¿«é€ŸéªŒè¯
- çº¿ä¸Šå»ºè®®ä½¿ç”¨ï¼š
    - FAISSï¼šæ€§èƒ½æ ‡æ†
    - Elasticsearchï¼šæ··åˆæœç´¢ï¼ˆå…³é”®è¯+å‘é‡ï¼‰è¡¨ç°ä¼˜å¼‚
    - Milvusã€Pineconã€Weaviateã€Qdrant ç­‰



![:caption: RAG çš„å‡ ç§æ¶æ„](/a/nn/llm/rag_structure.jpg)


### query æ”¹å†™å’Œè”ç½‘æœç´¢

**query æ”¹å†™**

```python
# å‚è€ƒå‰é¢ï¼Œä¼ å…¥ token
# client = OpenAI(...)


# åŸºäº prompt ç”Ÿæˆæ–‡æœ¬
def get_completion(prompt, model="DeepSeek-V3.2"):
    resp = client.chat.completions.create(
        model=model,
        messages=[{"role": "user", "content": prompt}]
    )

    return resp.choices[0].message.content


# Queryæ”¹å†™åŠŸèƒ½
class QueryRewriter:
    def __init__(self, model="DeepSeek-V3.2"):
        self.model = model

    def rewrite_context_dependent_query(self, current_query, conversation_history):
        """ä¸Šä¸‹æ–‡ä¾èµ–å‹Queryæ”¹å†™"""
        instruction = """
ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„æŸ¥è¯¢ä¼˜åŒ–åŠ©æ‰‹ã€‚è¯·åˆ†æç”¨æˆ·çš„å½“å‰é—®é¢˜ä»¥åŠå‰åºå¯¹è¯å†å²ï¼Œåˆ¤æ–­å½“å‰é—®é¢˜æ˜¯å¦ä¾èµ–äºä¸Šä¸‹æ–‡ã€‚
å¦‚æœä¾èµ–ï¼Œè¯·å°†å½“å‰é—®é¢˜æ”¹å†™æˆä¸€ä¸ªç‹¬ç«‹çš„ã€åŒ…å«æ‰€æœ‰å¿…è¦ä¸Šä¸‹æ–‡ä¿¡æ¯çš„å®Œæ•´é—®é¢˜ã€‚
å¦‚æœä¸ä¾èµ–ï¼Œç›´æ¥è¿”å›åŸé—®é¢˜ã€‚
"""

        prompt = f"""
### æŒ‡ä»¤ ###
{instruction}

### å¯¹è¯å†å² ###
{conversation_history}

### å½“å‰é—®é¢˜ ###
{current_query}

### æ”¹å†™åçš„é—®é¢˜ ###
"""

        return get_completion(prompt, self.model)

    def rewrite_comparative_query(self, query, context_info):
        """å¯¹æ¯”å‹Queryæ”¹å†™"""
        instruction = """
ä½ æ˜¯ä¸€ä¸ªæŸ¥è¯¢åˆ†æä¸“å®¶ã€‚è¯·åˆ†æç”¨æˆ·çš„è¾“å…¥å’Œç›¸å…³çš„å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œè¯†åˆ«å‡ºé—®é¢˜ä¸­éœ€è¦è¿›è¡Œæ¯”è¾ƒçš„å¤šä¸ªå¯¹è±¡ã€‚
ç„¶åï¼Œå°†åŸå§‹é—®é¢˜æ”¹å†™æˆä¸€ä¸ªæ›´æ˜ç¡®ã€æ›´é€‚åˆåœ¨çŸ¥è¯†åº“ä¸­æ£€ç´¢çš„å¯¹æ¯”æ€§æŸ¥è¯¢ã€‚
"""

        prompt = f"""
### æŒ‡ä»¤ ###
{instruction}

### å¯¹è¯å†å²/ä¸Šä¸‹æ–‡ä¿¡æ¯ ###
{context_info}

### åŸå§‹é—®é¢˜ ###
{query}

### æ”¹å†™åçš„æŸ¥è¯¢ ###
"""

        return get_completion(prompt, self.model)

    def rewrite_ambiguous_reference_query(self, current_query, conversation_history):
        """æ¨¡ç³ŠæŒ‡ä»£å‹Queryæ”¹å†™"""
        instruction = """
ä½ æ˜¯ä¸€ä¸ªæ¶ˆé™¤è¯­è¨€æ­§ä¹‰çš„ä¸“å®¶ã€‚è¯·åˆ†æç”¨æˆ·çš„å½“å‰é—®é¢˜å’Œå¯¹è¯å†å²ï¼Œæ‰¾å‡ºé—®é¢˜ä¸­ "éƒ½"ã€"å®ƒ"ã€"è¿™ä¸ª" ç­‰æ¨¡ç³ŠæŒ‡ä»£è¯å…·ä½“æŒ‡å‘çš„å¯¹è±¡ã€‚
ç„¶åï¼Œå°†è¿™äº›æŒ‡ä»£è¯æ›¿æ¢ä¸ºæ˜ç¡®çš„å¯¹è±¡åç§°ï¼Œç”Ÿæˆä¸€ä¸ªæ¸…æ™°ã€æ— æ­§ä¹‰çš„æ–°é—®é¢˜ã€‚
"""

        prompt = f"""
### æŒ‡ä»¤ ###
{instruction}

### å¯¹è¯å†å² ###
{conversation_history}

### å½“å‰é—®é¢˜ ###
{current_query}

### æ”¹å†™åçš„é—®é¢˜ ###
"""

        return get_completion(prompt, self.model)

    def rewrite_multi_intent_query(self, query):
        """å¤šæ„å›¾å‹Queryæ”¹å†™ - åˆ†è§£æŸ¥è¯¢"""
        instruction = """
ä½ æ˜¯ä¸€ä¸ªä»»åŠ¡åˆ†è§£æœºå™¨äººã€‚è¯·å°†ç”¨æˆ·çš„å¤æ‚é—®é¢˜åˆ†è§£æˆå¤šä¸ªç‹¬ç«‹çš„ã€å¯ä»¥å•ç‹¬å›ç­”çš„ç®€å•é—®é¢˜ã€‚ä»¥JSONæ•°ç»„æ ¼å¼è¾“å‡ºã€‚
"""

        prompt = f"""
### æŒ‡ä»¤ ###
{instruction}

### åŸå§‹é—®é¢˜ ###
{query}

### åˆ†è§£åçš„é—®é¢˜åˆ—è¡¨ ###
è¯·ä»¥JSONæ•°ç»„æ ¼å¼è¾“å‡ºï¼Œä¾‹å¦‚ï¼š["é—®é¢˜1", "é—®é¢˜2", "é—®é¢˜3"]
"""

        response = get_completion(prompt, self.model)
        try:
            return json.loads(response)
        except:
            return [response]

    def rewrite_rhetorical_query(self, current_query, conversation_history):
        """åé—®å‹Queryæ”¹å†™"""
        instruction = """
ä½ æ˜¯ä¸€ä¸ªæ²Ÿé€šç†è§£å¤§å¸ˆã€‚è¯·åˆ†æç”¨æˆ·çš„åé—®æˆ–å¸¦æœ‰æƒ…ç»ªçš„é™ˆè¿°ï¼Œè¯†åˆ«å…¶èƒŒåçœŸå®çš„æ„å›¾å’Œé—®é¢˜ã€‚
ç„¶åï¼Œå°†è¿™ä¸ªåé—®æ”¹å†™æˆä¸€ä¸ªä¸­ç«‹ã€å®¢è§‚ã€å¯ä»¥ç›´æ¥ç”¨äºçŸ¥è¯†åº“æ£€ç´¢çš„é—®é¢˜ã€‚
"""

        prompt = f"""
### æŒ‡ä»¤ ###
{instruction}

### å¯¹è¯å†å² ###
{conversation_history}

### å½“å‰é—®é¢˜ ###
{current_query}

### æ”¹å†™åçš„é—®é¢˜ ###
"""

        return get_completion(prompt, self.model)

    def auto_rewrite_query(self, query, conversation_history="", context_info=""):
        """è‡ªåŠ¨è¯†åˆ«Queryç±»å‹å¹¶è¿›è¡Œæ”¹å†™"""
        instruction = """
ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„æŸ¥è¯¢åˆ†æä¸“å®¶ã€‚è¯·åˆ†æç”¨æˆ·çš„æŸ¥è¯¢ï¼Œè¯†åˆ«å…¶å±äºä»¥ä¸‹å“ªç§ç±»å‹ï¼š
1. ä¸Šä¸‹æ–‡ä¾èµ–å‹ - åŒ…å«"è¿˜æœ‰"ã€"å…¶ä»–"ç­‰éœ€è¦ä¸Šä¸‹æ–‡ç†è§£çš„è¯æ±‡
2. å¯¹æ¯”å‹ - åŒ…å«"å“ªä¸ª"ã€"æ¯”è¾ƒ"ã€"æ›´"ã€"å“ªä¸ªæ›´å¥½"ã€"å“ªä¸ªæ›´"ç­‰æ¯”è¾ƒè¯æ±‡
3. æ¨¡ç³ŠæŒ‡ä»£å‹ - åŒ…å«"å®ƒ"ã€"ä»–ä»¬"ã€"éƒ½"ã€"è¿™ä¸ª"ç­‰æŒ‡ä»£è¯
4. å¤šæ„å›¾å‹ - åŒ…å«å¤šä¸ªç‹¬ç«‹é—®é¢˜ï¼Œç”¨"ã€"æˆ–"ï¼Ÿ"åˆ†éš”
5. åé—®å‹ - åŒ…å«"ä¸ä¼š"ã€"éš¾é“"ç­‰åé—®è¯­æ°”
è¯´æ˜ï¼šå¦‚æœåŒæ—¶å­˜åœ¨å¤šæ„å›¾å‹ã€æ¨¡ç³ŠæŒ‡ä»£å‹ï¼Œä¼˜å…ˆçº§ä¸ºå¤šæ„å›¾å‹>æ¨¡ç³ŠæŒ‡ä»£å‹

è¯·è¿”å›JSONæ ¼å¼çš„ç»“æœï¼š
{
    "query_type": "æŸ¥è¯¢ç±»å‹",
    "rewritten_query": "æ”¹å†™åçš„æŸ¥è¯¢",
    "confidence": "ç½®ä¿¡åº¦(0-1)"
}
"""

        prompt = f"""
### æŒ‡ä»¤ ###
{instruction}

### å¯¹è¯å†å² ###
{conversation_history}

### ä¸Šä¸‹æ–‡ä¿¡æ¯ ###
{context_info}

### åŸå§‹æŸ¥è¯¢ ###
{query}

### åˆ†æç»“æœ ###
"""

        response = get_completion(prompt, self.model)
        try:
            return json.loads(response)
        except:
            return {
                "query_type": "æœªçŸ¥ç±»å‹",
                "rewritten_query": query,
                "confidence": 0.5
            }

    def auto_rewrite_and_execute(self, query, conversation_history="", context_info=""):
        """è‡ªåŠ¨è¯†åˆ«Queryç±»å‹å¹¶è¿›è¡Œæ”¹å†™ï¼Œç„¶åæ ¹æ®ç±»å‹è°ƒç”¨ç›¸åº”çš„æ”¹å†™æ–¹æ³•"""
        # é¦–å…ˆè¿›è¡Œè‡ªåŠ¨è¯†åˆ«
        result = self.auto_rewrite_query(query, conversation_history, context_info)

        # æ ¹æ®è¯†åˆ«ç»“æœè°ƒç”¨ç›¸åº”çš„æ”¹å†™æ–¹æ³•
        query_type = result.get('query_type', '')

        if 'ä¸Šä¸‹æ–‡ä¾èµ–' in query_type:
            final_result = self.rewrite_context_dependent_query(query, conversation_history)
        elif 'å¯¹æ¯”' in query_type:
            final_result = self.rewrite_comparative_query(query, context_info or conversation_history)
        elif 'æ¨¡ç³ŠæŒ‡ä»£' in query_type:
            final_result = self.rewrite_ambiguous_reference_query(query, conversation_history)
        elif 'å¤šæ„å›¾' in query_type:
            final_result = self.rewrite_multi_intent_query(query)
        elif 'åé—®' in query_type:
            final_result = self.rewrite_rhetorical_query(query, conversation_history)
        else:
            # å¯¹äºå…¶ä»–ç±»å‹ï¼Œè¿”å›è‡ªåŠ¨è¯†åˆ«çš„æ”¹å†™ç»“æœ
            final_result = result.get('rewritten_query', query)

        return {
            "original_query": query,
            "detected_type": query_type,
            "confidence": result.get('confidence', 0.5),
            "rewritten_query": final_result,
            "auto_rewrite_result": result
        }


def main():
    # åˆå§‹åŒ–Queryæ”¹å†™å™¨
    rewriter = QueryRewriter()
    print("=== Queryæ”¹å†™åŠŸèƒ½ä½¿ç”¨ç¤ºä¾‹ï¼ˆè¿ªå£«å°¼ä¸»é¢˜ä¹å›­ï¼‰ ===\n")

    # ç¤ºä¾‹1: ä¸Šä¸‹æ–‡ä¾èµ–å‹Query
    print("ç¤ºä¾‹1: ä¸Šä¸‹æ–‡ä¾èµ–å‹Query")
    conversation_history = """
ç”¨æˆ·: "æˆ‘æƒ³äº†è§£ä¸€ä¸‹ä¸Šæµ·è¿ªå£«å°¼ä¹å›­çš„æœ€æ–°é¡¹ç›®ã€‚"
AI: "ä¸Šæµ·è¿ªå£«å°¼ä¹å›­æœ€æ–°æ¨å‡ºäº†'ç–¯ç‹‚åŠ¨ç‰©åŸ'ä¸»é¢˜å›­åŒºï¼Œè¿™é‡Œæœ‰æœ±è¿ªè­¦å®˜å’Œå°¼å…‹ç‹çš„äº’åŠ¨ä½“éªŒã€‚"
ç”¨æˆ·: "è¿™ä¸ªå›­åŒºæœ‰ä»€ä¹ˆæ¸¸ä¹è®¾æ–½ï¼Ÿ"
AI: "'ç–¯ç‹‚åŠ¨ç‰©åŸ'å›­åŒºç›®å‰æœ‰ç–¯ç‹‚åŠ¨ç‰©åŸè­¦å¯Ÿå±€ã€æœ±è¿ªè­¦å®˜è®­ç»ƒè¥å’Œå°¼å…‹ç‹çš„å†°æ·‡æ·‹åº—ç­‰è®¾æ–½ã€‚"
"""
    current_query = "è¿˜æœ‰å…¶ä»–è®¾æ–½å—ï¼Ÿ"

    print(f"å¯¹è¯å†å²: {conversation_history}")
    print(f"å½“å‰æŸ¥è¯¢: {current_query}")

    result = rewriter.rewrite_context_dependent_query(current_query, conversation_history)
    print(f"æ”¹å†™ç»“æœ: {result}\n")

    # ç¤ºä¾‹2: å¯¹æ¯”å‹Query
    print("ç¤ºä¾‹2: å¯¹æ¯”å‹Query")
    conversation_history = """
ç”¨æˆ·: "æˆ‘æƒ³äº†è§£ä¸€ä¸‹ä¸Šæµ·è¿ªå£«å°¼ä¹å›­çš„æœ€æ–°é¡¹ç›®ã€‚"
AI: "ä¸Šæµ·è¿ªå£«å°¼ä¹å›­æœ€æ–°æ¨å‡ºäº†ç–¯ç‹‚åŠ¨ç‰©åŸä¸»é¢˜å›­åŒºï¼Œè¿˜æœ‰èœ˜è››ä¾ ä¸»é¢˜å›­åŒº"
"""
    current_query = "å“ªä¸ªæ¸¸ç©çš„æ—¶é—´æ¯”è¾ƒé•¿ï¼Œæ¯”è¾ƒæœ‰è¶£"

    print(f"å¯¹è¯å†å²: {conversation_history}")
    print(f"å½“å‰æŸ¥è¯¢: {current_query}")

    result = rewriter.rewrite_comparative_query(current_query, conversation_history)
    print(f"æ”¹å†™ç»“æœ: {result}\n")

    # ç¤ºä¾‹3: æ¨¡ç³ŠæŒ‡ä»£å‹Query
    print("ç¤ºä¾‹3: æ¨¡ç³ŠæŒ‡ä»£å‹Query")
    conversation_history = """
ç”¨æˆ·: "æˆ‘æƒ³äº†è§£ä¸€ä¸‹ä¸Šæµ·è¿ªå£«å°¼ä¹å›­å’Œé¦™æ¸¯è¿ªå£«å°¼ä¹å›­çš„çƒŸèŠ±è¡¨æ¼”ã€‚"
AI: "å¥½çš„ï¼Œä¸Šæµ·è¿ªå£«å°¼ä¹å›­å’Œé¦™æ¸¯è¿ªå£«å°¼ä¹å›­éƒ½æœ‰ç²¾å½©çš„çƒŸèŠ±è¡¨æ¼”ã€‚"
"""
    current_query = "éƒ½ä»€ä¹ˆæ—¶å€™å¼€å§‹ï¼Ÿ"

    print(f"å¯¹è¯å†å²: {conversation_history}")
    print(f"å½“å‰æŸ¥è¯¢: {current_query}")

    result = rewriter.rewrite_ambiguous_reference_query(current_query, conversation_history)
    print(f"æ”¹å†™ç»“æœ: {result}\n")

    # ç¤ºä¾‹4: å¤šæ„å›¾å‹Query
    print("ç¤ºä¾‹4: å¤šæ„å›¾å‹Query")
    query = "é—¨ç¥¨å¤šå°‘é’±ï¼Ÿéœ€è¦æå‰é¢„çº¦å—ï¼Ÿåœè½¦è´¹æ€ä¹ˆæ”¶ï¼Ÿ"

    print(f"åŸå§‹æŸ¥è¯¢: {query}")

    result = rewriter.rewrite_multi_intent_query(query)
    print(f"åˆ†è§£ç»“æœ: {result}\n")

    # ç¤ºä¾‹5: åé—®å‹Query
    print("ç¤ºä¾‹5: åé—®å‹Query")
    conversation_history = """
ç”¨æˆ·: "ä½ å¥½ï¼Œæˆ‘æƒ³é¢„è®¢ä¸‹å‘¨å…­ä¸Šæµ·è¿ªå£«å°¼ä¹å›­çš„é—¨ç¥¨ã€‚"
AI: "æ­£åœ¨ä¸ºæ‚¨æŸ¥è¯¢... æŸ¥è¯¢åˆ°ä¸‹å‘¨å…­çš„é—¨ç¥¨å·²ç»å”®ç½„ã€‚"
ç”¨æˆ·: "å”®ç½„æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿæˆ‘æœ‹å‹ä¸Šå‘¨å»è¿˜èƒ½ä¹°åˆ°å½“å¤©çš„ç¥¨ã€‚"
"""
    current_query = "è¿™ä¸ä¼šä¹Ÿè¦æå‰ä¸€ä¸ªæœˆé¢„è®¢å§ï¼Ÿ"

    print(f"å¯¹è¯å†å²: {conversation_history}")
    print(f"å½“å‰æŸ¥è¯¢: {current_query}")

    result = rewriter.rewrite_rhetorical_query(current_query, conversation_history)
    print(f"æ”¹å†™ç»“æœ: {result}\n")

    # ç¤ºä¾‹6: è‡ªåŠ¨è¯†åˆ«Queryç±»å‹
    print("ç¤ºä¾‹6: è‡ªåŠ¨è¯†åˆ«Queryç±»å‹")
    test_queries = [
        "è¿˜æœ‰å…¶ä»–æ¸¸ä¹é¡¹ç›®å—ï¼Ÿ",
        "å“ªä¸ªå›­åŒºæ›´å¥½ç©ï¼Ÿ",
        "éƒ½é€‚åˆå°æœ‹å‹å—ï¼Ÿ",
        "æœ‰ä»€ä¹ˆé¤å…ï¼Ÿä»·æ ¼æ€ä¹ˆæ ·ï¼Ÿ",
        "è¿™ä¸ä¼šä¹Ÿè¦æ’é˜Ÿä¸¤å°æ—¶å§ï¼Ÿ"
    ]

    for i, query in enumerate(test_queries, 1):
        print(f"æµ‹è¯•æŸ¥è¯¢ {i}: {query}")
        result = rewriter.auto_rewrite_query(query)
        print(f"  è¯†åˆ«ç±»å‹: {result['query_type']}")
        print(f"  æ”¹å†™ç»“æœ: {result['rewritten_query']}")
        print(f"  ç½®ä¿¡åº¦: {result['confidence']}\n")


if __name__ == "__main__":
    main()
```



**è”ç½‘æ£€ç´¢**

```python

# å‚è€ƒå‰é¢ï¼Œä¼ å…¥ token
# client = OpenAI(...)


# åŸºäº prompt ç”Ÿæˆæ–‡æœ¬
def get_completion(prompt, model="DeepSeek-V3.2"):
    resp = client.chat.completions.create(
        model=model,
        messages=[{"role": "user", "content": prompt}]
    )

    return resp.choices[0].message.content


# Queryè”ç½‘æœç´¢æ”¹å†™åŠŸèƒ½
# å¯¼å…¥ä¾èµ–åº“
import os
import json
import re
from datetime import datetime


class WebSearchQueryRewriter:
    def __init__(self, model="DeepSeek-V3.2"):
        self.model = model

    def identify_web_search_needs(self, query, conversation_history=""):
        """è¯†åˆ«æŸ¥è¯¢æ˜¯å¦éœ€è¦è”ç½‘æœç´¢"""
        instruction = """
ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„æŸ¥è¯¢åˆ†æä¸“å®¶ã€‚è¯·åˆ†æç”¨æˆ·çš„æŸ¥è¯¢ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦è”ç½‘æœç´¢æ¥è·å–æœ€æ–°ã€æœ€å‡†ç¡®çš„ä¿¡æ¯ã€‚

éœ€è¦è”ç½‘æœç´¢çš„æƒ…å†µåŒ…æ‹¬ï¼š
1. æ—¶æ•ˆæ€§ä¿¡æ¯ - åŒ…å«"æœ€æ–°"ã€"ä»Šå¤©"ã€"ç°åœ¨"ã€"å®æ—¶"ã€"å½“å‰"ç­‰æ—¶é—´ç›¸å…³è¯æ±‡
2. ä»·æ ¼ä¿¡æ¯ - åŒ…å«"å¤šå°‘é’±"ã€"ä»·æ ¼"ã€"è´¹ç”¨"ã€"ç¥¨ä»·"ç­‰ä»·æ ¼ç›¸å…³è¯æ±‡
3. è¥ä¸šä¿¡æ¯ - åŒ…å«"è¥ä¸šæ—¶é—´"ã€"å¼€æ”¾æ—¶é—´"ã€"é—­å›­æ—¶é—´"ã€"æ˜¯å¦å¼€æ”¾"ç­‰è¥ä¸šçŠ¶æ€
4. æ´»åŠ¨ä¿¡æ¯ - åŒ…å«"æ´»åŠ¨"ã€"è¡¨æ¼”"ã€"æ¼”å‡º"ã€"èŠ‚æ—¥"ã€"åº†å…¸"ç­‰åŠ¨æ€ä¿¡æ¯
5. å¤©æ°”ä¿¡æ¯ - åŒ…å«"å¤©æ°”"ã€"ä¸‹é›¨"ã€"æ¸©åº¦"ç­‰å¤©æ°”ç›¸å…³
6. äº¤é€šä¿¡æ¯ - åŒ…å«"æ€ä¹ˆå»"ã€"äº¤é€š"ã€"åœ°é“"ã€"å…¬äº¤"ç­‰äº¤é€šæ–¹å¼
7. é¢„è®¢ä¿¡æ¯ - åŒ…å«"é¢„è®¢"ã€"é¢„çº¦"ã€"è´­ç¥¨"ã€"è®¢ç¥¨"ç­‰é¢„è®¢ç›¸å…³
8. å®æ—¶çŠ¶æ€ - åŒ…å«"æ’é˜Ÿ"ã€"æ‹¥æŒ¤"ã€"äººæµé‡"ç­‰å®æ—¶çŠ¶æ€

è¯·è¿”å›JSONæ ¼å¼ï¼š
{
    "need_web_search": true/false,
    "search_reason": "éœ€è¦æœç´¢çš„åŸå› ",
    "confidence": "ç½®ä¿¡åº¦(0-1)"
}
"""

        prompt = f"""
### æŒ‡ä»¤ ###
{instruction}

### å¯¹è¯å†å² ###
{conversation_history}

### ç”¨æˆ·æŸ¥è¯¢ ###
{query}

### åˆ†æç»“æœ ###
"""

        response = get_completion(prompt, self.model)
        try:
            return json.loads(response)
        except:
            return {
                "need_web_search": False,
                "search_reason": "æ— æ³•è§£æ",
                "confidence": 0.5
            }

    def rewrite_for_web_search(self, query, search_type="general"):
        """ä¸ºè”ç½‘æœç´¢æ”¹å†™æŸ¥è¯¢"""
        instruction = """
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æœç´¢æŸ¥è¯¢ä¼˜åŒ–ä¸“å®¶ã€‚è¯·å°†ç”¨æˆ·çš„æŸ¥è¯¢æ”¹å†™ä¸ºæ›´é€‚åˆæœç´¢å¼•æ“æ£€ç´¢çš„å½¢å¼ã€‚

æ”¹å†™æŠ€å·§ï¼š
1. æ·»åŠ å…·ä½“åœ°ç‚¹ - å¦‚"ä¸Šæµ·è¿ªå£«å°¼ä¹å›­"ã€"é¦™æ¸¯è¿ªå£«å°¼ä¹å›­"
2. æ·»åŠ æ—¶é—´èŒƒå›´ - å¦‚"2024å¹´"ã€"ä»Šå¤©"ã€"æœ¬å‘¨"
3. ä½¿ç”¨å…³é”®è¯ç»„åˆ - å°†é•¿å¥æ‹†åˆ†ä¸ºå…³é”®è¯
4. æ·»åŠ æœç´¢æ„å›¾ - æ˜ç¡®æœç´¢ç›®çš„
5. å»é™¤å£è¯­åŒ–è¡¨è¾¾ - è½¬æ¢ä¸ºæ ‡å‡†æœç´¢è¯
6. æ·»åŠ ç›¸å…³è¯æ±‡ - å¢åŠ åŒä¹‰è¯æˆ–ç›¸å…³è¯

è¯·è¿”å›JSONæ ¼å¼ï¼š
{
    "rewritten_query": "æ”¹å†™åçš„æœç´¢æŸ¥è¯¢",
    "search_keywords": ["å…³é”®è¯1", "å…³é”®è¯2", "å…³é”®è¯3"],
    "search_intent": "æœç´¢æ„å›¾",
    "suggested_sources": ["å»ºè®®æœç´¢çš„ç½‘ç«™ç±»å‹"]
}
"""

        prompt = f"""
### æŒ‡ä»¤ ###
{instruction}

### åŸå§‹æŸ¥è¯¢ ###
{query}

### æœç´¢ç±»å‹ ###
{search_type}

### æ”¹å†™ç»“æœ ###
"""

        response = get_completion(prompt, self.model)
        try:
            return json.loads(response)
        except:
            return {
                "rewritten_query": query,
                "search_keywords": [query],
                "search_intent": "ä¿¡æ¯æŸ¥è¯¢",
                "suggested_sources": ["å®˜æ–¹ç½‘ç«™", "æ—…æ¸¸ç½‘ç«™"]
            }

    def generate_search_strategy(self, query, search_type="general"):
        """ç”Ÿæˆæœç´¢ç­–ç•¥"""
        current_date = datetime.now().strftime("%Yå¹´%mæœˆ%dæ—¥")
        instruction = f"""
ä½ æ˜¯ä¸€ä¸ªæœç´¢ç­–ç•¥ä¸“å®¶ã€‚è¯·ä¸ºç”¨æˆ·çš„æŸ¥è¯¢åˆ¶å®šè¯¦ç»†çš„æœç´¢ç­–ç•¥ã€‚

å½“å‰æ—¥æœŸï¼š{current_date}

æœç´¢ç­–ç•¥åŒ…æ‹¬ï¼š
1. ä¸»è¦æœç´¢è¯ - æ ¸å¿ƒå…³é”®è¯
2. æ‰©å±•æœç´¢è¯ - ç›¸å…³è¯æ±‡å’ŒåŒä¹‰è¯
3. æœç´¢ç½‘ç«™ - æ¨èçš„æœç´¢å¹³å°
4. æ—¶é—´èŒƒå›´ - å…·ä½“çš„æœç´¢æ—¶é—´èŒƒå›´

è¯·è¿”å›JSONæ ¼å¼ï¼š
{{
    "primary_keywords": ["ä¸»è¦å…³é”®è¯"],
    "extended_keywords": ["æ‰©å±•å…³é”®è¯"],
    "search_platforms": ["æœç´¢å¹³å°"],
    "time_range": "å…·ä½“çš„æ—¶é—´èŒƒå›´"
}}
"""

        prompt = f"""
### æŒ‡ä»¤ ###
{instruction}

### ç”¨æˆ·æŸ¥è¯¢ ###
{query}

### æœç´¢ç±»å‹ ###
{search_type}

### æœç´¢ç­–ç•¥ ###
"""

        response = get_completion(prompt, self.model)
        try:
            return json.loads(response)
        except:
            return {
                "primary_keywords": [query],
                "extended_keywords": [],
                "search_platforms": ["ç™¾åº¦", "è°·æ­Œ"],
                "time_range": "æœ€è¿‘ä¸€å‘¨"
            }

    def auto_web_search_rewrite(self, query, conversation_history=""):
        """è‡ªåŠ¨è¯†åˆ«å¹¶æ”¹å†™ä¸ºè”ç½‘æœç´¢æŸ¥è¯¢"""
        # ç¬¬ä¸€æ­¥ï¼šè¯†åˆ«æ˜¯å¦éœ€è¦è”ç½‘æœç´¢
        search_analysis = self.identify_web_search_needs(query, conversation_history)

        if not search_analysis.get('need_web_search', False):
            return {
                "need_web_search": False,
                "reason": "æŸ¥è¯¢ä¸éœ€è¦è”ç½‘æœç´¢",
                "original_query": query
            }

        # ç¬¬äºŒæ­¥ï¼šæ”¹å†™æŸ¥è¯¢
        rewritten_result = self.rewrite_for_web_search(query)

        # ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆæœç´¢ç­–ç•¥
        search_strategy = self.generate_search_strategy(query)

        return {
            "need_web_search": True,
            "search_reason": search_analysis.get('search_reason', ''),
            "confidence": search_analysis.get('confidence', 0.5),
            "original_query": query,
            "rewritten_query": rewritten_result.get('rewritten_query', query),
            "search_keywords": rewritten_result.get('search_keywords', []),
            "search_intent": rewritten_result.get('search_intent', ''),
            "suggested_sources": rewritten_result.get('suggested_sources', []),
            "search_strategy": search_strategy
        }


def main():
    # åˆå§‹åŒ–è”ç½‘æœç´¢Queryæ”¹å†™å™¨
    web_searcher = WebSearchQueryRewriter()

    print("=== Queryè”ç½‘æœç´¢è¯†åˆ«ä¸æ”¹å†™ç¤ºä¾‹ï¼ˆè¿ªå£«å°¼ä¸»é¢˜ä¹å›­ï¼‰ ===\n")

    # ç¤ºä¾‹1: æ—¶æ•ˆæ€§ä¿¡æ¯æŸ¥è¯¢
    print("ç¤ºä¾‹1: æ—¶æ•ˆæ€§ä¿¡æ¯æŸ¥è¯¢")
    conversation_history1 = """
ç”¨æˆ·: "æˆ‘æƒ³å»ä¸Šæµ·è¿ªå£«å°¼ä¹å›­ç©"
AI: "ä¸Šæµ·è¿ªå£«å°¼ä¹å›­æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„é€‰æ‹©ï¼"
"""
    query1 = "ä¸Šæµ·è¿ªå£«å°¼ä¹å›­ä»Šå¤©å¼€æ”¾å—ï¼Ÿç°åœ¨äººå¤šä¸å¤šï¼Ÿ"

    print(f"å¯¹è¯å†å²: {conversation_history1}")
    print(f"å½“å‰æŸ¥è¯¢: {query1}")

    result1 = web_searcher.auto_web_search_rewrite(query1, conversation_history1)

    if result1['need_web_search']:
        print(f"âœ“ éœ€è¦è”ç½‘æœç´¢")
        print(f"  æœç´¢åŸå› : {result1['search_reason']}")
        print(f"  ç½®ä¿¡åº¦: {result1['confidence']}")
        print(f"  æ”¹å†™æŸ¥è¯¢: {result1['rewritten_query']}")
        print(f"  æœç´¢å…³é”®è¯: {result1['search_keywords']}")
        print(f"  æœç´¢æ„å›¾: {result1['search_intent']}")
        print(f"  å»ºè®®æ¥æº: {result1['suggested_sources']}")
        print(f"  æœç´¢ç­–ç•¥:")
        print(f"    - ä¸»è¦å…³é”®è¯: {result1['search_strategy']['primary_keywords']}")
        print(f"    - æ‰©å±•å…³é”®è¯: {result1['search_strategy']['extended_keywords']}")
        print(f"    - æœç´¢å¹³å°: {result1['search_strategy']['search_platforms']}")
        print(f"    - æ—¶é—´èŒƒå›´: {result1['search_strategy']['time_range']}")
    else:
        print(f"âœ— ä¸éœ€è¦è”ç½‘æœç´¢")
        print(f"  åŸå› : {result1['reason']}")

    print("\n" + "=" * 60 + "\n")

    # ç¤ºä¾‹2: ä»·æ ¼å’Œé¢„è®¢ä¿¡æ¯æŸ¥è¯¢
    print("ç¤ºä¾‹2: ä»·æ ¼å’Œé¢„è®¢ä¿¡æ¯æŸ¥è¯¢")
    query2 = "ä¸‹å‘¨å…­çš„é—¨ç¥¨å¤šå°‘é’±ï¼Ÿéœ€è¦æå‰å¤šä¹…é¢„è®¢ï¼Ÿ"

    print(f"å½“å‰æŸ¥è¯¢: {query2}")

    result2 = web_searcher.auto_web_search_rewrite(query2)

    if result2['need_web_search']:
        print(f"âœ“ éœ€è¦è”ç½‘æœç´¢")
        print(f"  æœç´¢åŸå› : {result2['search_reason']}")
        print(f"  ç½®ä¿¡åº¦: {result2['confidence']}")
        print(f"  æ”¹å†™æŸ¥è¯¢: {result2['rewritten_query']}")
        print(f"  æœç´¢å…³é”®è¯: {result2['search_keywords']}")
        print(f"  æœç´¢æ„å›¾: {result2['search_intent']}")
        print(f"  å»ºè®®æ¥æº: {result2['suggested_sources']}")
        print(f"  æœç´¢ç­–ç•¥:")
        print(f"    - ä¸»è¦å…³é”®è¯: {result2['search_strategy']['primary_keywords']}")
        print(f"    - æ‰©å±•å…³é”®è¯: {result2['search_strategy']['extended_keywords']}")
        print(f"    - æœç´¢å¹³å°: {result2['search_strategy']['search_platforms']}")
        print(f"    - æ—¶é—´èŒƒå›´: {result2['search_strategy']['time_range']}")
    else:
        print(f"âœ— ä¸éœ€è¦è”ç½‘æœç´¢")
        print(f"  åŸå› : {result2['reason']}")


if __name__ == "__main__":
    main()
```



## Agent

Agent æ˜¯åŒ…å«äº† RAGã€æç¤ºè¯ã€Function callingã€Re-Actç­‰ä¸€ç³»åˆ—å…ƒç´ çš„é›†åˆ
- API è°ƒç”¨ï¼Œä¾‹å¦‚æŸ¥è¯¢å¤©æ°”ã€å‘é€é‚®ä»¶
- Re-Act


**è‡ªä¸»Agent**
- ç”± Planner æ¨¡å—ï¼ˆä¹Ÿæ˜¯ä¸ªLLMï¼‰ï¼Œä¸å…¶å®ƒ LLMã€å·¥å…·è°ƒç”¨çš„é…åˆ



## Fine-tuning


**Scaling Law** LLaMA:å³ä½¿æ˜¯7Bæ¨¡å‹ï¼Œè®­ç»ƒæ•°æ®ç»§ç»­æ‰©å±•åˆ° 1T tokenï¼Œå…¶æ€§èƒ½ä»ç„¶ä¼šä¸Šå‡


**ä¸ºä»€ä¹ˆéœ€è¦å¾®è°ƒï¼Ÿ**
- æ›´æ”¹æç¤ºè¯æ–¹ä¾¿å¿«æ·ï¼Œä½†æ˜¯æœ‰ä¸Šé™ï¼š
- é¢†åŸŸæ¨¡å‹ç»éªŒéš¾ä»¥æè¿°
- prompt å¤ªé•¿ï¼Œéµå¾ªç¨‹åº¦ä½ã€‚
- prompt éµå¾ªæœ‰å¹»è§‰
- å“ªäº›ä»»åŠ¡é€‚åˆ SFTï¼Ÿ
- Prompt æ”¾ä¸ä¸‹ï¼Œä¾‹å¦‚æŸä¸ªç³»ç»Ÿæœ‰æ•°ä¸‡æ¡è§„åˆ™ã€‚
- ä¸€äº›æ–°çš„æ€è€ƒæ–¹å¼ï¼Œä¾‹å¦‚æ—¥å¿—åˆ†æå¤§æ¨¡å‹ï¼Œå¯ä»¥è®©å®ƒå­¦ä¼šæ²¿ç€æŠ¥é”™ stack åˆ†æ
- æŸäº›æ–‡é£ï¼ˆä¾‹å¦‚è§’è‰²æ‰®æ¼”ï¼‰ã€é£é™©åå¥½å¯¹é½ç­‰ç­‰


**æœ‰å“ªäº›æ€è·¯**
- å¤§æ¨¡å‹ï¼ˆå¦‚ DeepSeek-671Bï¼‰åœ¨ç‰¹å®šé¢†åŸŸçš„çŸ¥è¯†è½¬ç§»åˆ°å°æ¨¡å‹å¦‚ï¼ˆQwen-0.6Bï¼‰ã€‚å¦‚æ­¤ï¼Œå¯ä»¥åœ¨æ¨ç†æ—¶è·å¾—åŒæ–¹çš„ä¼˜ç‚¹ï¼šå°æ¨¡å‹çš„QPSã€å°èµ„æºæ¶ˆè€—ï¼Œæ¥è¿‘å¤§æ¨¡å‹å‡†ç¡®ç‡ã€‚
    - æ–¹æ³•å’Œæµç¨‹ï¼šå¤§æ¨¡å‹ -> è·å¾—COTæ•°æ® -> è’¸é¦å°æ¨¡å‹
- å¤§æ¨¡å‹->ä¸“å®¶ç»éªŒï¼ˆGround truthï¼‰->è’¸é¦å°æ¨¡å‹
    - æ–¹æ³•å’Œæµç¨‹ï¼šä¸“å®¶ç”¨äººå·¥çš„æ–¹å¼æä¾›ç­”æ¡ˆ/æ¨ç†ï¼ˆå¯ä»¥å€ŸåŠ©å¤§æ¨¡å‹ï¼Œæˆ–è€…ä¸å€ŸåŠ©å¤§æ¨¡å‹ï¼‰ã€‚æˆæœ¬è¾ƒé«˜ã€‚
- **RSFT**ï¼ˆæ‹’ç»é‡‡æ · SFTï¼‰ï¼š
    - ä¼ ç»Ÿ SFT æ•°æ®æ˜¯ç”¨å¤§æ¨¡å‹ï¼ˆå¦‚ DeepSeek-R1ï¼‰ç”Ÿæˆ CoT å’Œç­”æ¡ˆã€‚ç„¶åå‰”é™¤ä½è´¨é‡çš„ï¼Œç”¨äºè®­ç»ƒå°æ¨¡å‹ã€‚
    - RSFT æ˜¯è®©å°æ¨¡å‹Aäº§ç”Ÿ CoT å’Œç­”æ¡ˆï¼Œç”¨å¤§æ¨¡å‹åˆ¤æ–­è´¨é‡å¹¶ç­›é€‰ï¼Œç„¶åè®­ç»ƒå°æ¨¡å‹Aã€‚
    - å› ä¸ºè®­ç»ƒæ•°æ®æ¥è‡ª A è‡ªå·±ï¼Œå®ƒæ˜¯ä¼šè¿™äº›çš„ï¼Œåªæ˜¯æ€è·¯ä¸èƒ½æ”¶æ•›äºæ­£ç¡®ç­”æ¡ˆã€‚è¿™æ ·å¯ä»¥å¸®åŠ©å…¶æ€è·¯æ”¶æ•›ï¼Œå› æ­¤æ•ˆæœå¾ˆå¥½ã€‚
- **RFT**ï¼šRL+SFTï¼Œå‡»æºƒæ˜¯ RSFT çš„åŸºç¡€ä¸Šï¼Œç”¨é«˜è´¨é‡çš„ä¸€ç»„é—®é¢˜åšå›ç­”å’Œå¥–æƒ©ã€‚




**ä»€ä¹ˆæ—¶å€™éœ€è¦ï¼Ÿ**
- å¦‚æœæ˜¯é€šè¯†åœºæ™¯ï¼Œä¸éœ€è¦ SFT
- å¦‚æœåœºæ™¯æ¯”è¾ƒå†·åƒ»ï¼Œå°±éœ€è¦ SFT

**æœ‰å“ªäº›æ–¹æ³•**
- å…¨é‡å¾®è°ƒï¼ˆFull Finetuneï¼‰ï¼šæ‰€æœ‰å‚æ•°éƒ½æ›´æ–°
- å‚æ•°é«˜æ•ˆå¾®è°ƒï¼ˆPEFTï¼ŒParameter-Efficient-Finetuneï¼‰ï¼Œä»…è°ƒæ•´éƒ¨åˆ†å‚æ•°
    - LoRAï¼šé€šè¿‡ä½ç§©çŸ©é˜µåˆ†è§£æ¨¡æ‹Ÿæƒé‡æ›´æ–°
    - è¿˜æœ‰ Adapterã€Prefix Tuning ç­‰
    - QLoRAï¼šæ˜¯é‡åŒ– + LoRAï¼Œå†»ç»“çš„åŸºåº§æ¨¡å‹ç”¨ 4bit æ”¾æ˜¾å­˜
- å¼ºåŒ–å­¦ä¹ ï¼ˆReinforcement Learningï¼‰
    - äººç±»åé¦ˆå¼ºåŒ–å­¦ä¹ ï¼ˆRLHFï¼‰ï¼šäººç±»å¯¹æ¨¡å‹è¾“å‡ºè¯„ä»·ï¼Œä½¿å…¶ç¬¦åˆäººç±»ä»·å€¼è§‚å’Œä»»åŠ¡éœ€æ±‚
    - è¿‘ç«¯ç­–ç•¥ä¼˜åŒ–ï¼ˆPPOï¼‰ï¼šé€šè¿‡ç­–ç•¥æ¢¯åº¦æ›´æ–°
    - ç›´æ¥åå¥½ä¼˜åŒ–ï¼ˆDPOï¼‰ï¼šæ— éœ€æ˜¾å¼è®­ç»ƒå¥–åŠ±ï¼Œæ˜¯PPOçš„ç®€åŒ–
    - ç»„ç›¸å¯¹ç­–ç•¥ä¼˜åŒ–ï¼ˆGRPOï¼‰




**base model é€‰æ‹©**
- å¤æ‚SFTä»»åŠ¡ï¼šé€‰ 7B ä»¥ä¸Š
- é«˜æ€§èƒ½ä»»åŠ¡ï¼šé€‰ 1B ä»¥ä¸‹



### è·å–æ•°æ®

**æ–¹æ³•1ç›´æ¥ç”¨å¤§æ¨¡å‹ç”ŸæˆCOT**ã€‚ä¾‹å¦‚ï¼Œç›´æ¥ç”¨åŸºåº§æ¨¡å‹ï¼ˆä¾‹å¦‚ DeepSeek-R1/V3ï¼Œ ChatGPTï¼‰ç”ŸæˆCOTæ•°æ®

**æ–¹æ³•2è®¾è®¡å¤šæ™ºèƒ½ä½“** ä¾‹å¦‚ï¼Œè®¾è®¡2ä¸ªæ™ºèƒ½ä½“ã€‚ä¸€ä¸ªæ‰®æ¼”å®¢æœä¸“å®¶ï¼Œä¸€ä¸ªæ‰®æ¼”å®¢æˆ·
- å®¢æœä¸“å®¶äº§ç”Ÿè¯æœ¯
- å®¢æˆ·æå‡ºæ„è§ï¼Œä¾‹å¦‚ï¼Œâ€œå¢åŠ å‹å¥½å’Œå…³å¿ƒçš„è¯­æ°”â€ã€â€œè¿™æ®µè¯æœ¯ç¨æ˜¾å†—é•¿â€
- å®¢æœä¸“å®¶æ ¹æ®æ„è§åšä¼˜åŒ–
- æ•°è½®ä¹‹åï¼ˆ3-5è½®ï¼‰ï¼Œå¾—åˆ°ä¼˜åŒ–åçš„è¯æœ¯ã€‚
- ç”¨å¦ä¸€ä¸ª LLM åšä¸€è½®è¿‡æ»¤ï¼Œå¾—åˆ°æœ€ç»ˆçš„æ•°æ®é›†


**æ–¹æ³•3:ä¼ ç»Ÿæ–¹æ³•**
- ä¸šåŠ¡ç³»ç»Ÿæ”¶é›†ï¼ˆé¢„è®­ç»ƒä¸€èˆ¬ä¸ç”¨è¿™ä¸ªï¼Œå› ä¸ºæœ‰æ•°æ®æ³„éœ²é£é™©ï¼Œä½† SFT ç»å¸¸éœ€è¦ï¼‰
- å¼€æºæ•°æ®é›†
    - å¼€æºæ•°æ®é›†
    - HuggingFaceã€GitHub
- çˆ¬è™«ã€‚çˆ¬åˆ°çš„æ•°æ®ï¼Œè§£æé˜¶æ®µä¹Ÿå¯ä»¥ç”¨ LLM äº†
- é‡‡ä¹°ï¼šé¢˜åº“ã€ä¹¦ç±ã€æ•™æ
- ...


### é«˜è´¨é‡è®­ç»ƒæ•°æ®

æ•°æ®ä¸éœ€è¦å¤ªå¤šï¼š*Metaã€ŠLIMAã€‹ï¼š1kä¼˜è´¨æ ·æœ¬å³å¯æ‰“è´¥æµ·é‡æ™®é€šæ•°æ®*ã€‚å› æ­¤ï¼Œè·å– **é«˜è´¨é‡è®­ç»ƒæ•°æ®** æ˜¯å…³é”®

**æ•°æ®è´¨é‡è¯„ä¼°**
- **å‡†ç¡®**
    - **æ— äº‹å®é”™è¯¯**
    - **ä¸€è‡´æ€§**ï¼šå†…éƒ¨å¤„ç†é€»è¾‘ç»Ÿä¸€ï¼Œæ•°æ®ä¹‹é—´æ²¡æœ‰äº’ç›¸çŸ›ç›¾
    - å…¶å®ƒé—®é¢˜ï¼Œæ‹¼å†™æ£€æŸ¥ä¸çº æ­£ã€æ–‡æœ¬è§„èŒƒåŒ–ï¼ˆå¦‚æœ‰å¿…è¦çš„è¯ï¼Œä¾‹å¦‚å°å†™åŒ–ã€å»é™¤ç‰¹æ®Šå­—ç¬¦ï¼‰ã€ç¡®å®šé€‚å½“çš„æœ€å¤§æ–‡æœ¬é•¿åº¦ã€‚
    - æ–¹æ³•å’Œå·¥å…·ï¼š
        - äººå·¥è´¨é‡æŠ½æ£€
        - rule-basedï¼šæ ¼å¼å‡†ç¡®æ€§ç­‰å¤šé‡è§„åˆ™
        - LLM as judge
        - æ„å»ºé™æ€æŒ‡æ ‡ï¼šä¾‹å¦‚ï¼Œè¾“å‡ºé•¿åº¦/PPLç­‰
            - **PPL** ï¼ˆå›°æƒ‘åº¦ï¼Œperplexityï¼‰çš„è®¡ç®—ï¼šé¢„æµ‹ä¸‹ä¸€ä¸ªè¯æ—¶çš„â€œå¹³å‡äº¤å‰ç†µâ€çš„æŒ‡æ•°ã€‚å®ƒå¤§äº1ï¼Œå¹¶ä¸”è¶Šå¤§ä»£è¡¨è¶Šä¸ç¡®å®šã€‚
            - **PPL** è¿‡é«˜å’Œè¿‡ä½éƒ½è¦å‰”é™¤ã€‚è¿‡ä½ä»£è¡¨ä¸å¿…å†å­¦äº†ï¼Œè¿‡é«˜çš„ä¹Ÿæ˜¯å­¦ä¸ä¼šã€‚
        - å€Ÿç”¨å¼€æº reward model/å¾®è°ƒè‹¥å¹²å¤§æ¨¡å‹æ¥å®ç°æ•°æ®è´¨é‡å¥–åŠ±/è®­ç»ƒå°æ¨¡å‹
- **å®Œæ•´æ€§** ï¼ˆè¦†ç›–ä»»åŠ¡è¦ç‚¹ï¼‰
    - è¦†ç›–å…¨éƒ¨éœ€è¦çš„ **ä»»åŠ¡ç±»å‹**
    - **éš¾åº¦æ¢¯åº¦** ç®€å•/ä¸­ç­‰/å¤æ‚ä»»åŠ¡æ¯”ä¾‹åˆç†
    - è¦†ç›–å…¨éƒ¨éœ€è¦çš„ **æ–‡æœ¬ä¸»é¢˜** 
    - **æ•°æ®æ´å‡€åº¦**ï¼šå‰”é™¤é‡å¤ã€å™ªå£°ã€é”™è¯¯çš„æ ·æœ¬
    - å»é™¤å†—ä½™æ•°æ®
    - æ­£è´Ÿæ ·æœ¬å‡è¡¡
    - æ ·æœ¬ç›¸å…³æ€§ï¼Œæ•æ‰æ•°æ®é›†çš„ä¸Šä¸‹æ–‡å’Œè¯­ä¹‰å¤šæ ·æ€§ã€‚ï¼ˆç”Ÿæˆçš„æŒ‡ä»¤å’Œå…¶æœ€ç›¸ä¼¼çš„ç§å­æŒ‡ä»¤ä¹‹é—´çš„ROUGE-Låˆ†æ•°åˆ†å¸ƒã€‚ï¼‰
    - kmeans/k-centerï¼ˆè®¡ç®—å¤æ‚åº¦è¾ƒä½ï¼‰ï¼Œ æŒ‘é€‰å‡ºå¤šæ ·æ€§çš„æ•°æ®ï¼Œå³Seed Instruction Dataã€‚è¿™æ­¥å…³æ³¨çš„æ˜¯ coverageã€‚
- **ç®€æ´æ€§**ï¼šï¼ˆæ— å†—ä½™ä¿¡æ¯ï¼‰
    - é«˜è´¨é‡çš„é‡å¤æ•°æ®ï¼Œå¯ä»¥æå‡æ¨¡å‹æ•ˆæœã€‚ä½†ä¸­ç­‰è´¨é‡ä¼šæµªè´¹è®¡ç®—èµ„æºã€é™ä½æ³›åŒ–æ€§ã€‚
    

å®æ“æµç¨‹
- å»é‡ï¼š**md5**ã€**MinHash**
- ä½è´¨é‡è¿‡æ»¤
    - å…³é”®è¯è¿‡æ»¤ã€è§„åˆ™è¿‡æ»¤
    - ç”¨â€å°â€œæ¨¡å‹ï¼ˆä¾‹å¦‚ Qwen-7Bï¼‰è®¡ç®— PPLï¼ˆPPLå¤ªä½ã€å¤ªé«˜éƒ½ä¸é€‚åˆè®­ç»ƒï¼‰
    - ...
- å»æ¯’ï¼šé»„ã€èµŒã€æ¯’ã€æ¶‰æ”¿ã€éšç§å»é™¤
- æ•°æ®é›†æ•´ä½“è¯„ä¼°ï¼šæ¶ˆèå®éªŒã€‚
    - æ˜¯ä»€ä¹ˆï¼šæŠŠæ–°çš„æ•°æ®é›†ï¼Œåœ¨ä¹‹å‰æ¨¡å‹çš„ checkpoint ä¸Šç»§ç»­è®­ç»ƒï¼Œè§‚å¯Ÿå…¶åœ¨å„ä¸ªéªŒè¯é›†ï¼ˆæ¦œå•ï¼‰ä¸Šçš„è¡¨ç°
    - ç›®çš„ï¼šè¯„ä¼°æ–°æ•°æ®é›†æ˜¯å¦ï¼š1ï¼‰æä¾›å¢é‡çŸ¥è¯†ï¼Œ2ï¼‰ä¸æŸå®³å·²è®­ç»ƒçš„æ•ˆæœ
    - å®éªŒç»“æœï¼šæ•ˆæœæå‡ï¼Œè¯´æ˜æœ‰æå‡ï¼›æ•ˆæœä¸‹é™ï¼Œè¯´æ˜æŸå®³äº†å·²è®­ç»ƒçš„æ•ˆæœï¼›æ•ˆæœä¸å˜ï¼Œè¯´æ˜æ–°æ•°æ®é›†æ²¡æœ‰å¸¦æ¥æå‡
    - éš¾ç‚¹ï¼šå¤šä¸ªéªŒè¯é›†ï¼Œæœ‰çš„æå‡ï¼Œæœ‰çš„ä¸‹é™ï¼Œæ€ä¹ˆåŠï¼Ÿ





**ä¸šåŠ¡çŸ¥è¯†å¦‚ä½•èå…¥**
- ä¸“å®¶çš„æ„Ÿæ€§çŸ¥è¯†ã€‚å…¸å‹å†å²æ¡ˆä¾‹ -> ï¼ˆå¤§æ¨¡å‹ï¼‰æŠ½å–ä¸“å®¶çŸ¥è¯† -> æ²‰æ·€ä¸ºä¸šåŠ¡çŸ¥è¯†
- ç­–ç•¥/æ­£åˆ™è¡¨è¾¾å¼/è§„åˆ™ -> ç¿»è¯‘æˆäººè¯ -> æ²‰æ·€ä¸ºä¸“å®¶ç»éªŒ
- ä¸šåŠ¡ä¸“æœ‰åç§° -> æ•´ç†å‡ºä¸šåŠ¡â€œè¯å…¸â€







## SFT


å¦‚ä½•è®­ç»ƒ
- loss. SFT æ—¶ï¼Œä¸€èˆ¬ä¼š mask æ‰ prompt éƒ¨åˆ†çš„ lossï¼Œåªå­¦ä¹ è¾“å‡ºéƒ¨åˆ†çš„ loss
- å­¦ä¹ ç‡. ä¸€èˆ¬æ˜¯é¢„è®­ç»ƒçš„å­¦ä¹ ç‡çš„ 0.1 å€
- epoch. å°æ ·æœ¬ï¼ˆ<1ä¸‡ï¼‰5ä¸ªï¼Œå¤§æ ·æœ¬ï¼ˆ>1ä¸‡ï¼‰2ä¸ª
- æ··å…¥ 30%-50% é«˜è´¨é‡é¢„è®­ç»ƒæ•°æ®ï¼ˆé€šç”¨æ•°æ®ï¼‰ï¼Œé˜²æ­¢ç¾éš¾æ€§é—å¿˜ï¼Œä¿æŒæ³›åŒ–èƒ½åŠ›

å…³é”®æŒ‡æ ‡
- ä¸šåŠ¡åˆæ ¼ç‡ï¼šä»ä¸šåŠ¡å‡ºå‘ï¼Œäººå·¥å¯¹ç»“æœæ‰“æ ‡ï¼Œç»™å‡º good/ok/badï¼Œå¹¶è®¡ç®—æŒ‡æ ‡
- æå‡ç‡ï¼šæŒ‡æ ‡æ¯”ä¸Šä¸€ä¸ªç‰ˆæœ¬æå‡äº†å¤šå°‘


LoRAï¼ˆLow-Rank Adaptation of Large Language Modelsï¼‰
- æ ¸å¿ƒåŸç†æ˜¯çŸ©é˜µåˆ†è§£ $\Delta W_{d\times k} = B_{d\times r} A_{r\times k}$ï¼Œå½“ r è¾ƒå°æ—¶ï¼ŒA å’Œ B çš„å‚æ•°é‡å°±å¾ˆå°
    - è®­ç»ƒæ—¶å†»ç»“åŸæ¥çš„æ¨¡å‹å‚æ•° $W$ï¼Œ
    - éšæœºåˆå§‹åŒ– $A$ å’Œ $B$ï¼Œè®­ç»ƒæ—¶æ›´æ–°çš„æ˜¯  $A$ å’Œ $B$
    - æœ€åæŒ‰ç…§ $W + \Delta W = W + AB$ æ¥æ›´æ–°å‚æ•°
- éœ€è¦è°ƒæ•´çš„å‚æ•°å°‘
- è¿˜æœ‰åˆ©äºå¤šå¡å¹¶è¡Œè®­ç»ƒ
- å› æ­¤å¾ˆå¿«ã€æ˜¾å­˜å ç”¨ä¹Ÿä½
    - å…·ä½“æ¥è¯´ï¼Œå…¨å‚è®­ç»ƒç›¸æ¯”éœ€è¦è®¡ç®—å…¨éƒ¨å‚æ•°çš„æ¢¯åº¦ï¼ˆæ˜¾å­˜è§’åº¦ï¼šéœ€è¦å­˜å‚¨å…¨éƒ¨æ¢¯åº¦ä»¥åŠä¼˜åŒ–å™¨çŠ¶æ€ï¼‰ï¼›è€Œ LoRA ä¸éœ€è¦è¿™äº›ï¼Œä½†æ˜¯é¢å¤–éœ€è¦è®¡ç®— LoRA éƒ¨åˆ†çš„å‰å‘ã€æ¢¯åº¦ï¼Œä½†è¿™ä¸ªå æ¯”åªæœ‰1%-3%
- æ¨ç†æ—¶ï¼Œæœ‰ sLoRA è¿™æ ·çš„æŠ€æœ¯ï¼Œä½¿å…¶å…±äº«é¢„è®­ç»ƒæ¨¡å‹å‚æ•°ï¼Œè¿›ä¸€æ­¥é™ä½æ¨ç†æˆæœ¬ã€‚


LoRA è¯„ä»·
- æœ€ç»ˆæ•ˆæœä½äºå…¨é‡å¾®è°ƒ
- å¦‚æœåŸºåº§æ¨¡å‹è¡¨ç°ä¸å¥½ï¼ŒLoRA å¤§æ¦‚ç‡ä¸å¥½ï¼ˆå› ä¸ºåªæ”¹åŠ¨äº†ä¸€éƒ¨åˆ†å‚æ•°ï¼‰
- LoRA è®°å¿†åŠ›ä¸å¦‚å…¨å‚å¾®è°ƒ

ä¸€ä¸ªä¸“é—¨è§£æ•°å­¦é¢˜çš„7Bæ¨¡å‹è®­ç»ƒæ­¥éª¤ï¼š
- step1: ç”¨ Math-500ï¼ˆå¼€æºæ•°æ®é›†ï¼‰åš SFT
- step2: ç°ä»·ä¸€ä¸ªéš¾åº¦è¿‡æ»¤å™¨ï¼Œä¿è¯æ¯æ¬¡è®­ç»ƒæ­£å¥½æ˜¯æœ‰äº›éš¾åº¦çš„
- step3: è’¸é¦è¶…å¤§æ¨¡å‹çš„ CoT
- step4: æ”¹å–„ CoTï¼Œè¿™ä¸ªä¾‹å­çš„å®éªŒè¡¨ç¤ºï¼ŒCoT è¦ç®€ç¹é€‚ä¸­ã€ç»™å‡ºå¤šä¸ªæ€è·¯ã€‚

æ•°æ®é‡ç»éªŒå€¼ï¼šæœ€å°‘100æ¡ï¼Œä»¥ 5000æ¡ä¸ºä½³



## GRPO

åŒºåˆ«ï¼š
- SFTï¼šç”¨å¤§æ¨¡å‹å‡†å¤‡æ•°æ®ï¼Œç»™å°æ¨¡å‹æ¥è®­ç»ƒ
- RLï¼šé—®é¢˜æè¿°ï¼ˆInitial State æ— Outputï¼‰ï¼Œåªéœ€è¦è¶³å¤Ÿå¤šæ ·çš„é—®é¢˜ï¼Œæ— éœ€ç­”æ¡ˆ

ä¸ºä»€ä¹ˆï¼šâ€œSFTè´Ÿè´£è®°å¿†ï¼ŒRLè´Ÿè´£æ³›åŒ–â€
- SFT Memorizes, RL Generalizes: A Comparative Study of Foundation Model Post-trainingï¼Œhttps://arxiv.org/abs/2501.17161


å¤§æ¨¡å‹ç›¸å…³çš„ RL å‘å±•å†å²ï¼š
1. PPOï¼šç”¨äº†4ä¸ªæ¨¡å‹ï¼šActor Modelï¼ˆå¤§æ¨¡å‹æœ¬èº«ï¼‰ï¼ŒRef Modelï¼ˆå†»ç»“çš„æ¨¡å‹ï¼‰ï¼ŒReward Modelï¼ŒCritic Modelï¼ˆå¯¹æ¯ä¸ªçŠ¶æ€çš„è¯„ä¼°ï¼Œé¢„æµ‹æœªæ¥çš„æ½œåœ¨å›æŠ¥ï¼‰
2. DPOï¼šç”¨ä¸€äº›æ•°å­¦æŠ€å·§ï¼Œçœå»äº† Critic Modelã€Reward Modelã€Ref Modelï¼Œåªéœ€è¦ Actor Model å’Œ accept/reject ã€‚æ€§èƒ½å¾ˆå¥½ã€‚Reward å¾ˆéš¾å†™ã€‚
3. GRPOï¼Œç”¨ç»„å†…ç›¸å¯¹ç»“æœæ¥è®¡ç®—å¥–åŠ±ï¼Œæ— éœ€ Criticï¼ˆèŠ‚çœå†…å­˜ï¼‰



GRPOï¼ˆGroup Relative Policy Optimizationï¼‰åŒ…å«3ä¸ªæ¨¡å‹
- Actor Modelï¼šæ˜¯è®­ç»ƒè¿‡ç¨‹ä¸­éœ€è¦ä¼˜åŒ–çš„æ ¸å¿ƒç­–ç•¥æ¨¡å‹ï¼Œè´Ÿè´£æ ¹æ®è¾“å…¥ç”Ÿæˆå€™é€‰è¾“å‡ºã€‚é€šè¿‡ç”Ÿæˆå¤šä¸ªè¾“å‡ºï¼ˆå¦‚æ•°å­¦é¢˜çš„å¤šè§£æ–¹æ¡ˆï¼‰è¿›è¡Œç¾¤ä½“å†…å¯¹æ¯”ã€‚
- Reward Modelï¼šç”¨äºè¯„ä¼°Actorç”Ÿæˆè¾“å‡ºçš„è´¨é‡ï¼Œä¸ºæ¯ä¸ªè¾“å‡ºåˆ†é…å¥–åŠ±å€¼ã€‚é€šè¿‡ç¾¤ä½“å½’ä¸€åŒ–ï¼ˆå¦‚å‡å»å‡å€¼ã€é™¤ä»¥æ ‡å‡†å·®ï¼‰å°†ç»å¯¹å¥–åŠ±è½¬æ¢ä¸ºç›¸å¯¹ä¼˜åŠ¿ï¼Œæ›¿ä»£ä¼ ç»Ÿä¼˜åŠ¿å‡½æ•°è®¡ç®—ã€‚
    - **è¿™ä¸ªéƒ¨åˆ†ä¹Ÿå¯ä»¥æ˜¯ä¸ªè§„åˆ™ï¼Œè€Œä¸æ˜¯ Model**ï¼Œä¾‹å¦‚ï¼š
    - æ ¼å¼å¥–åŠ±ï¼ˆä¾‹å¦‚æ˜¯å¦æœ‰think å’Œ answerï¼Œä¾‹å¦‚æ ¼å¼æ˜¯å¦ç¬¦åˆé¢„æœŸï¼‰
    - ç»“æœæ­£ç¡®æ€§å¥–åŠ±ã€‚æœ‰äº›é—®é¢˜å¯ä»¥ç”¨è§„åˆ™åˆ¤æ–­
    - å…¶å®ƒå¥–åŠ±ï¼š
        - è¯­è¨€ä¸€è‡´æ€§
        - é•¿åº¦å¥–åŠ±
        - é‡å¤æ€§æƒ©ç½š
        - æ€è€ƒè¿‡ç¨‹å¥–åŠ±ï¼Œæ¡ç†æ€§ã€é€»è¾‘æ€§
- Reference Modelï¼šæ˜¯ä¸€ä¸ªå†»ç»“ï¼ˆå‚æ•°ä¸æ›´æ–°ï¼‰çš„åŸºå‡†æ¨¡å‹ï¼Œç”¨äºè®¡ç®—KLæ•£åº¦ï¼ˆKullback-Leibler Divergenceï¼‰ï¼Œçº¦æŸActor Modelçš„ç­–ç•¥æ›´æ–°å¹…åº¦ï¼Œé˜²æ­¢å…¶è¿‡åº¦åç¦»åˆå§‹ç­–ç•¥ã€‚


GRPOçš„ç®—æ³•æµç¨‹
1. åˆ†ç»„é‡‡æ ·å“åº”ã€‚å¯¹åŒä¸€ä¸ª Prompt ç”Ÿæˆä¸€ç»„å“åº”ï¼ˆ4-8ä¸ªï¼‰
2. ç»„å†…è¯„åˆ†è¯­æ’åã€‚æ ¹æ®Reward Modelï¼ˆæˆ–è§„åˆ™ï¼‰ï¼Œå¯¹æ¯ä¸ªå“åº”è¯„åˆ†ï¼Œç„¶åï¼Œç›¸å¯¹ä¼˜åŠ¿=ä¸ªä½“å¾—åˆ†-ç»„å¹³å‡åˆ†
3. ç­–ç•¥ä¼˜åŒ–æ–¹å‘ã€‚å¼ºåŒ–å­¦ä¹ å¾—åˆ†ç›¸å¯¹ä¼˜åŠ¿é«˜çš„ï¼ŒæŠ‘åˆ¶ç›¸å¯¹ä¼˜åŠ¿ä½çš„ã€‚


## Post-Pretrain

ä½¿ç”¨å¤§é‡æ•°æ®ï¼Œåœ¨ä¸€ä¸ªå·²ç»è®­ç»ƒå¥½çš„æ¨¡å‹ä¸Šç»§ç»­è®­ç»ƒã€‚


ä¸¾ä¾‹ï¼šæœ‰ä¸€ä¸ªè‹±æ–‡çš„å¤§æ¨¡å‹ï¼Œæƒ³åšä¸€ä¸ªä¸­æ–‡+é‡‘èå¤§æ¨¡å‹ã€‚åšæ³•ï¼š


![:caption: Post-Pretrain](/a/nn/llm/post_pretrain.svg)


Post-Pretrain å’Œ SFT çš„åŒºåˆ«
- SFT ä¸»è¦æ˜¯é—®ç­”æ ¼å¼çš„è¯­æ–™ï¼ŒPost-Pretrain æ˜¯æ™®é€šçš„è¯­æ–™
- loss æœ‰å¯¹åº”çš„è°ƒæ•´


## æ€§èƒ½ä¸èµ„æº

ä¸€èˆ¬ç»“è®ºï¼šæ¨ç†éœ€è¦çš„æ˜¾å­˜ä¸ºæ¨¡å‹å¤§å°çš„2ï½3å€ï¼›åè®­ç»ƒéœ€è¦8ï½10å€ï¼›LoRA åè®­è¦20%è¿™ä¸ªé‡çº§ã€‚

å½±å“å› ç´ 
- æ¨¡å‹æœ¬èº«çš„å˜é‡ä¸ªæ•°ï¼Œä¾‹å¦‚ Qwen-14B æœ‰ 14Billion ä¸ªå‚æ•°ï¼›Qwen-7B æœ‰ 7Billion ä¸ªå‚æ•°
- å˜é‡ç±»å‹ï¼šInt8 éœ€è¦ 1ä¸ªå­—èŠ‚ï¼›FP16/BF16 éœ€è¦2ä¸ªå­—èŠ‚ï¼›FP32 éœ€è¦4ä¸ªå­—èŠ‚
    - æ¨ç†æ—¶ç”¨å°ç²¾åº¦ï¼šå«åš **é‡åŒ–**
    - æœ€å¸¸ç”¨çš„ï¼šBF16ï¼ˆèŒƒå›´å¤§ã€ç²¾åº¦å°ï¼‰
    - æ¸¸æˆå¡å¯ä»¥è·‘å¤§æ¨¡å‹ï¼Œä¸èƒ½åšå·¥ä¸šæ¸²æŸ“
- **æ¨ç†** å‡è®¾å‚æ•°é‡ä¸º Xï¼Œç”¨ BF16ï¼Œå…¨éƒ¨å‚æ•°å ç”¨ 2Xï¼ŒKVç¼“å­˜ç•™ 20%ï¼Œå…¶å®ƒæŸè€—ç•™ 10%ï¼Œå…± `2 * 1.3 = 2.6`ï¼ˆç»éªŒå€¼æ˜¯ 2ï½3 å€ï¼‰
- **è®­ç»ƒ** å‚æ•° 2Xï¼Œæ¢¯åº¦ 2Xï¼Œä¼˜åŒ–å™¨ Adam 4Xã€æ¿€æ´»å’ŒæŸè€— 30%ï¼Œ`2X(1 + 1 + 2 + 0.3) = 8.6X`


æ¨ç†æ€§èƒ½æŒ‡æ ‡
- é¦–å­—å»¶è¿Ÿï¼ˆTFFTï¼‰ã€‚æ¨¡å‹å¼€å§‹è®¡ç®—ï¼Œåˆ°äº§ç”Ÿç¬¬ä¸€ä¸ª Token æ¶ˆè€—çš„æ—¶é—´ã€‚
    - è¿™ä¸ªæ—¶é—´å†…ï¼Œå¤§æ¨¡å‹ä¼šæŠŠè¾“å…¥çš„ Prompt é€ Token è®¡ç®—ä¸€è¾¹ï¼Œå¹¶å»ºç«‹ KV Cache
    - é€šå¸¸æ˜¯ç§’çº§
- ç”Ÿæˆé€Ÿåº¦ï¼ˆTPOTï¼‰ã€‚ä¹‹åçš„ Token ç”Ÿæˆé€Ÿåº¦ã€‚
    - é€šå¸¸æ˜¯å‡ åæ¯«ç§’çº§
- QPS

æ€§èƒ½æé«˜æŠ€æœ¯
- å¹¶è¡Œã€‚è¿™é‡Œæœ‰å¾ˆå¤šæŠ€æœ¯
    - å¹¶è¡Œè®­ç»ƒï¼Œå¤šä¸ªbatchå¹¶è¡Œå¤„ç†ï¼Œç„¶åæ±‡èšæ¢¯åº¦
    - æŠŠå¤§çŸ©é˜µä¹˜æ³•åˆ†è§£åˆ°å¤šä¸ªå¡ä¸Šå¹¶è¡Œï¼Œè®¡ç®—é€Ÿåº¦æå‡ï¼Œä½†é€šä¿¡å¼€é”€å˜å¤§ã€‚
    - åŸºç¡€å·¥å…·ï¼šPyTorch Distributedã€DeepSpeedã€é€šä¿¡åè®® NCLLï¼ˆNVIDIA Collective Communications Libraryï¼Œä¸º GPU ä¼˜åŒ–çš„é€šä¿¡åº“ï¼Œæ˜¯ Pytorch çš„åŸºç¡€ä¹‹ä¸€ï¼‰
- ç”¨ BP16ï¼Œè€Œä¸æ˜¯ FP32
- prefix cache
    - é€‚ç”¨äº query æœ‰å…±åŒçš„å‰ç¼€ã€‚ä¾‹å¦‚ç³»ç»Ÿæç¤ºè¯éƒ½ä¸€æ ·ã€‚
- continuous batchï¼šæŒ‰ batchï¼ŒæŠŠä¸€æ‰¹éœ€è¦é¢„æµ‹çš„æ”¾åˆ°ä¸€èµ·ã€‚ï¼ˆç±»ä¼¼å‘é‡åŒ–è¿ç®—ï¼‰
- é‡åŒ–ï¼ˆQuantizationï¼‰ å­¦æœ¯ç•Œéå¸¸å¤šçš„æ–¹æ³•æå‡º
    - ä¾‹å¦‚ï¼ŒFP32 è½¬ INT8
- å‰ªæï¼ˆPruningï¼‰ï¼šå»é™¤æ¥è¿‘0çš„æƒé‡
- ç¨€ç–åŒ–ã€‚
    - å‹ç¼©è¾“å…¥ï¼Œåªé€‰å–é‡è¦çš„ Tokenï¼ˆgemfilterï¼‰ï¼›
    - å‹ç¼© MLP è®¡ç®—ï¼ˆå¯¹ FNN æ¨¡å—åšå‰ªæï¼‰
    - å‹ç¼© attention ï¼ˆSeerAttentionï¼‰
- ä¸€äº›ç®€å•çš„ä»»åŠ¡ï¼Œè·¯ç”±åˆ°æ›´å°çš„æ¨¡å‹
- å¦‚æœæ¨¡å‹åªå¤„ç†ç‰¹ç‚¹é¢†åŸŸçš„ä»»åŠ¡ï¼Œè€ƒè™‘ distill
- å¤§å°æ¨¡å‹é…åˆï¼ˆç›¸å…³æŠ€æœ¯å¤æ‚ï¼‰



## å¤§æ¨¡å‹è¯„ä¼°



æµ‹è¯„å¤§æ¨¡å‹ï¼ˆ*A Survey on Evaluation of Language Models*ï¼‰https://arxiv.org/abs/2307.03109
- éªŒè¯æ€§èƒ½å’Œèƒ½åŠ›
- è¯„ä¼°æ³›åŒ–èƒ½åŠ›ï¼šåœ¨æœªè§è¿‡çš„æ•°æ®ä¸Šä¹Ÿä¿æŒè‰¯å¥½
- æ˜ç¡®ä¸åŒçš„å¤§æ¨¡å‹å·®å¼‚ï¼šäº†è§£å…¶ä¼˜åŠ¿é¢†åŸŸ
- é˜²æ­¢å¤§æ¨¡å‹é£é™©ï¼šå®‰å…¨æ¼æ´ä¹‹ç±»çš„
- çŸ¥é“å¤§æ¨¡å‹æ”¹è¿›ï¼šè¯†åˆ«æ¨¡å‹å¼±ç‚¹ã€æä¾›ä¼˜åŒ–æ–¹å‘

ä¸€äº›çŸ¥è¯†ç‚¹
- æœ‰æ—¶å€™ï¼Œå¤šä¸€ä¸ªæ¢è¡Œç¬¦ï¼Œå¯èƒ½å¯¹ç»“æœäº§ç”Ÿè¾ƒå¤§å½±å“

æµ‹è¯„æ–¹æ³•
- åœ¨æœ‰æ ‡å‡†ç­”æ¡ˆçš„æ•°æ®é›†ä¸Šè¯„æµ‹ï¼šå¦‚ä½•æå–æ¨¡å‹çš„ç­”æ¡ˆ
- é’ˆå¯¹é€‰æ‹©é¢˜ï¼Œè®¡ç®—æ¯ä¸ªé€‰é¡¹çš„ PPL
- å¯¹æŠ—æµ‹è¯„ï¼šåœ¨å¦ä¸€ä¸ªæ¨¡å‹ä¸Šå¾—åˆ°å›ç­”ï¼Œæ¯”è¾ƒ A å›ç­” å’Œ B å›ç­”çš„å¥½åã€‚è§£å†³çš„é—®é¢˜ï¼šæœ‰æ—¶å€™å•çº¯çœ‹ç­”æ¡ˆï¼Œä¸èƒ½å¾ˆå¥½çš„æ ‡æ³¨å›ç­”çš„å¥½åã€‚
    - ä¸åŸºçº¿æ¨¡å‹å¯¹æŠ—
    - å¤šä¸ªæ¨¡å‹ä¸¤ä¸¤å¯¹æŠ—


è¯„ä¼°é—®é¢˜
- å°é—­å¼é—®é¢˜ï¼šä½¿ç”¨é¢„å…ˆå·²ç»æœ‰çš„ç­”æ¡ˆå®Œæˆæµ‹è¯„
- å¼€æ”¾å¼é—®é¢˜ï¼š
    - äººå·¥æµ‹è¯„
    - å¤§æ¨¡å‹æµ‹è¯„



----------------

**å®‰å…¨è¯„ä¼°**
- å†…ç”Ÿå®‰å…¨ï¼šåœ¨æ•°æ®å’Œæ¨¡å‹å±‚é¢çš„å®‰å…¨
    - æ•°æ®æŠ•æ¯’ï¼šæ“çºµè®­ç»ƒæ ·æœ¬ï¼Œä½¿ LLM åœ¨ç‰¹å®šè§¦å‘æ¡ä»¶ä¸‹è¾“å‡ºæœ‰å®³ç»“æœ
    - æ¨¡å‹å¹»è§‰ã€‚è¯¸å¦‚åŒ»ç–—ã€é‡‘èã€æ³•å¾‹åœºæ™¯å¯èƒ½é€ æˆä¸¥é‡åæœã€‚ä¸»è¦é  RAGã€MCP 
        - å¼•è¯ç”Ÿæˆï¼šè¦æ±‚æ¨¡å‹æ ‡è®°æ¥æº
            - æ–¹å¼1:inline citationsï¼Œç”¨ prompt çº¦æŸï¼šâ€œæ¯å¥å¿…é¡»å¸¦å¼•ç”¨â€ã€â€œåªå…è®¸å¼•ç”¨ç»™å®š sources åˆ—è¡¨â€ã€â€œå¼•ç”¨å¿…é¡»æ¥è‡ªæ”¯æŒè¯¥å¥çš„åŸæ–‡ï¼Œä¸æ”¯æŒå°±è¯´ä¸çŸ¥é“â€ã€‚ç¼ºç‚¹æ˜¯ä»ç„¶ä¼šæœ‰å¹»è§‰
            - æ–¹å¼2:post-hoc attributionï¼Œå…ˆè®©æ¨¡å‹ç”Ÿæˆä¸å¸¦å¼•ç”¨çš„ç­”æ¡ˆï¼Œå¯¹æ¯ä¸ª claim åšè¯æ®åŒ¹é…ï¼ˆ1. ç”¨ embedding æ¥åŒ¹é…ï¼Œ2. ç”¨ LLM æ¥åŒ¹é…ï¼‰ã€‚æ›´å¯æ§ï¼Œä½†å·¥ç¨‹å¤æ‚ã€è€—æ—¶é«˜
        - self-RAGï¼šç”± LLM è‡ªåŠ¨å†³å®šæ˜¯å¦æ£€ç´¢ã€æ£€ç´¢ä»€ä¹ˆã€å¦‚ä½•ä½¿ç”¨è¯æ®ã€ä½•æ—¶åœæ­¢
    - ä»·å€¼è§‚é—®é¢˜
- æœåŠ¡å®‰å…¨ï¼šAI+ã€æ™ºèƒ½ä½“ã€å„ç§æœåŠ¡çš„æ¼æ´
    - æ•°æ®æ³„éœ²ï¼ˆç”¨æˆ·éšç§ã€æç¤ºè¯ä¹‹ç±»çš„ï¼‰
    - å®‰å…¨æ”»å‡»ï¼ˆç±»æ¯”ä¼ ç»Ÿçš„äº’è”ç½‘æ”»å‡»ï¼‰
    - ä¾›åº”é“¾é£é™©
    - ...
- ä½¿ç”¨ä¸Šçš„å®‰å…¨ã€æœªæ¥çš„å®‰å…¨é—®é¢˜
    - ä¼ªé€ 
    - è™šå‡æ–°é—»
    - é”™è¯¯çš„é‡å¤§å»ºè®®ï¼ˆåŒ»ç–—ã€é‡‘èï¼‰

è¯„ä¼°çš„æ¿å—
- å†…å®¹å®‰å…¨ï¼šé»„èµŒæ¯’ã€è¿·ä¿¡ã€ææ€–æš´åŠ›
- æ„è¯†å½¢æ€
- æ•°æ®å®‰å…¨
- ä¼¦ç†ï¼šèº«å¿ƒå¥åº·ã€å…¬åºè‰¯ä¿—ã€ç¤¼è²Œã€é˜²æ­§è§†
- åˆè§„ï¼šç¬¦åˆå›½å®¶çš„éƒ¨é—¨è§„ç« ï¼ˆé‡‘èã€åŒ»ç–—ã€æ”¿åŠ¡ç­‰ï¼‰
- è‡ªæˆ‘è®¤çŸ¥ï¼šxxå…¬å¸å¼€å‘çš„xxæ¨¡å‹
- çœŸå®æ€§


æ”»å‡»æ‰‹æ³•
- æŒ‡ä»¤åŠ«æŒ
    - å£ä»¤å¤è¿°
    - æ­£åä»‹ç»
    - å¾ªåºæ¸è¿›
    - æƒ…æ™¯å¸¦å…¥
    - ...
- ç»•è¿‡æ£€æµ‹
    - å†…æ¶µ
    - è—å¤´è¯—
    - åµŒå¥—
- ...


æ¨¡å‹æ°´å°
- æ¨¡å‹æ–‡ä»¶æ°´å°ã€AIGCæ ‡è¯†
- å‚æ•°çº§æ°´å°
- è¡Œä¸ºçº§æ°´å°ï¼šç‰¹å®šè¾“å…¥ï¼Œä½¿å…¶å‘ˆç°ç‰¹æ®Šçš„è¾“å‡º
- æ•°æ®æ°´å°ï¼šâ€œå–„æ„â€ç‰ˆæœ¬çš„æ•°æ®æŠ•æ¯’



## ä¸€äº› AI äº§å“æ¶æ„


**ä¸€ã€è½¬å‘å›å¤æ¶æ„**

![:caption: è½¬å‘å›å¤æ¶æ„](/a/nn/llm/agent_structure1.svg)


è¿™ä¸ªæ˜¯æœ€ç®€å•çš„æ¶æ„ï¼Œå¸¸ç”¨äºèŠå¤© app


**åˆ†æ‹†ä»»åŠ¡æ¶æ„**


<div class="mermaid">
graph TB
A[ç”¨æˆ·è¯·æ±‚]
B[å‰ç«¯]

subgraph S[ ]
direction LR
C[åç«¯]
E1((æ¨¡å‹1))
E2((æ¨¡å‹2))
E3((æ¨¡å‹3))
D[æ•°æ®åº“]
end

A --> B
B --> A
B --> C
C --> B
C --> D
D --> C
C --> E1
E1 --> C
C --> E2
E2 --> C
C --> E3
E3 --> C
</div>

ä¸¾ä¾‹ï¼š
- è®ºæ–‡é˜…è¯»åŠ©æ‰‹ï¼Œä¼šæœ‰å¤šä¸ªæ¨¡å‹ï¼Œåšä¸åŒçš„ä»»åŠ¡
- AI PPTï¼Œæœ‰çš„æ¨¡å‹è§„åˆ’å¤§çº²ï¼Œæœ‰çš„æ¨¡å‹ç”»ç»“æ„ï¼Œæœ‰çš„æ¨¡å‹å¡«å†…å®¹


**ä¸‰ã€äº‹ä»¶è§¦å‘**


<div class="mermaid">
graph TB
A[å…¶å®ƒç³»ç»Ÿ]
D[åŠ¨ä½œ]

A --->|è§¦å‘ï¼ˆäº‹ä»¶ã€å®šæ—¶ï¼‰| B

subgraph S[ ]
direction LR
B[åç«¯ç³»ç»Ÿ]
C[Agent]
end

B --> C
C --> D
</div>

ä¾‹å­ï¼š
- æ–°é—»è®¢é˜…
- é‡‘èäº‹ä»¶å“åº”ç³»ç»Ÿ
- å¸‚åœºè°ƒç ”åŠ©æ‰‹ï¼šé—®å·æ”¶é›†åˆ°ä¸€å®šæ•°é‡åï¼Œå¯åŠ¨æµç¨‹ï¼Œæœ€ç»ˆç»™ç”¨æˆ·è¾“å‡ºæŠ¥å‘Š


**æ„ŸçŸ¥å¯åŠ¨**


![:caption: æ„ŸçŸ¥å¯åŠ¨](/a/nn/llm/agent_structure4.svg)

ä¾‹å­ï¼šæ³•å¾‹å’¨è¯¢åŠ©æ‰‹
- Agentï¼šè§‚å¯Ÿå¯¹è¯ã€ç†è§£è¦ç‚¹ã€åˆ¤æ–­æ½œåœ¨éœ€æ±‚ã€åŒ¹é…ç±»ä¼¼æ¡ˆä»¶ç­‰


**å…¶å®ƒï¼šä»¥ä¸Šæ¶æ„çš„ç»„åˆ**


## å¤šAgent

æ•´ä½“æ€è·¯
- è§’è‰²åˆ†è§£ï¼š
    - supervisorï¼šåªè´Ÿè´£éœ€æ±‚æ‹†è§£ã€åˆ†å‘ä»»åŠ¡ï¼Œæ²¡æœ‰æ‰§è¡Œæƒé™
    - æ‰§è¡Œè€…ï¼šè´Ÿè´£æ‰§è¡Œå…·ä½“çš„ä»»åŠ¡
    - SOPæ ‡å‡†åŒ–
- äººè®¾éš”ç¦»ï¼Œåˆ’åˆ†ä¸åŒçš„äººè®¾ï¼Œä¸åŒçš„äººå¯ä½¿ç”¨ä¸åŒçš„å·¥å…·é›†
    - äººè®¾ï¼šâ€œä½ æ˜¯ä¸€ä¸ªèµ„æ·±Javaå¼€å‘ï¼Œåªè´Ÿè´£å¼€å‘åç«¯ä»£ç â€
    - å·¥å…·ï¼šä¾‹å¦‚æ£€ç´¢ã€Pythonè§£é‡Šå™¨ã€æ•°æ®åº“è¯»å†™
- é€šä¿¡æœºåˆ¶
    - ç‚¹å¯¹ç‚¹ä¼ é€’ï¼šé€‚åˆçº¿å½¢ä»»åŠ¡
    - å…±äº«é»‘æ¿ï¼šå…¨å±€å…±äº«å½“å‰çŠ¶æ€ï¼Œé€‚åˆå¤æ‚ä»»åŠ¡
- åä½œæ¨¡å¼
    - **å±‚çº§å¼**ï¼šBoss -> Leader -> Worker
        - ä¸­å¿ƒåŒ–è°ƒåº¦
        - æ•ˆç‡é«˜
    - **è¾©è®ºå¼**ï¼š Agent A VS Agent B
        - å¤šè½®äº’æ–¥è®¨è®ºå’Œ reviewï¼Œå‡†ç¡®ç‡é«˜
    - **æµæ°´çº¿**ï¼šå›ºå®šé¡ºåºæ‰§è¡Œï¼Œé€‚åˆ SOP æ˜ç¡®çš„ä»»åŠ¡







é—®é¢˜
- é”™è¯¯å åŠ ï¼Œæ•´ä½“å‡ºé”™æ¦‚ç‡æé«˜
- è´è¶æ•ˆåº”ï¼Œé”™è¯¯ä¼ å¯¼
- è§£å†³æ–¹æ¡ˆï¼š
    - æ–­ç‚¹ç»­ä¼ 
    - agentåˆ¤æ–­è°ƒç”¨é”™è¯¯çŠ¶æ€ï¼Œå¹¶è‡ªåŠ¨è¡ŒåŠ¨




å·¥ç¨‹ç»éªŒ
- å¤š Agent ä¸èƒ½äº’ç›¸è€¦åˆã€‚
    - å¦åˆ™ï¼šé£æ ¼ï¼ˆæ€è·¯ï¼‰ä¸ç»Ÿä¸€ï¼Œå³ä½¿å®ƒä»¬å…±äº«ä¸Šä¸‹æ–‡ï¼›
    - å†³ç­–ä¸æ‰§è¡Œå°½é‡ç”¨åŒä¸€ä¸ªæ¨¡å‹ã€‚
    - å¯ä»¥æ‹†å‡ºæ¥çš„ï¼šä¾‹å¦‚ä¸€ä¸ªå­Agentå»æŸ¥è¯¢ã€å­¦ä¹ ä¸€ä¸ªç”Ÿåƒ»çš„åº“ï¼Œè€Œç»ä¸èƒ½ç”¨å®ƒæ¥å†™ä»£ç ã€‚






## ä¸€äº›æ–¹å‘

### text2sql

æµç¨‹
1. ç”¨æˆ·é—®é¢˜
2. æ„å»º prompt
    - é€‰æ‹© schema
    - æ„å»ºçš„ Prompt è¦æ±‚ï¼šç®€æ´ã€ä¸¥æ ¼è§„å®šä¸å‡†è‡ªç”±å‘æŒ¥ã€ä¸å‡†è§£é‡Šï¼Œå¯ä»¥æ·»åŠ  few shot
3. ç”Ÿæˆ SQL
    - ç”¨ä¸€ä¸ªå•ç‹¬çš„ LLM æ¥æ‰§è¡Œ
    - å¯ä»¥ç”Ÿæˆ N ä»½ï¼Œç„¶åè®©æ¨¡å‹é€‰æ‹©æœ€ä¼˜çš„
4. æ ¡éªŒ
    - è§„åˆ™æ ¡éªŒ
    - æ¨¡å‹æ ¡éªŒ
5. æ‰§è¡Œ
    - å¦‚æœ‰æŠ¥é”™ï¼Œåˆ™è¿”å›ç»™å¤§æ¨¡å‹
6. ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰è§£é‡Šç»“æœï¼Œç»“æ„åŒ–æ•°æ®è½¬æ–‡æœ¬
