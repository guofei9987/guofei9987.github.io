---
layout: post
title: 【PyLSHasH】Locality Sensitive Hashing
categories: 开源
tags:
keywords:
description:
repo_name: pyLSHash
---

## 项目地址

https://github.com/guofei9987/pyLSHash


## 原理

这样一个任务：
1. 数据库中存了 1亿 个 n 维向量
2. 设计一个系统，使它能够
3. 每次有一个 n 维向量 query 这个系统时，能够给出数据库中与它相似（距离较近）的向量
4. 首先想到的是用暴力遍历，计算 1亿 次距离，然后卡阈值，但这效率极低
5. 引出这里要介绍的一个算法：Locality Sensitive Hashing，它可以很好的解决此问题



算法原理很简单：
1. 随机生成一个矩阵 $K_{m\times n}$，然后求矩阵积 $K_{m\times n} \vec a_{n\times 1}$
2. 把结果离散化，就是 $\vec a$ 的 “指纹”。
    - 这里的离散化就粗暴一些：大于0记为1，否则记为0。指纹长度为 m
3. 因为矩阵是随机生成的，离散化也粗暴，因此可以把以上多做几次，也就是对饮 `num_hashtables` 个矩阵









几何角度理解
- 从几何角度，矩阵积实际上是 m 个向量积。
- 向量积 $\vec k \cdot \vec a_1$ 和 $\vec k \cdot \vec a_2$ 相似，意味着 $\vec a_1, \vec a_2$ 在向量 $\vec k$ 上的投影相似
- 回到矩阵积，m 个投影都相似，也就意味着 $\vec a_1, \vec a_2$ 在 m 个基看来是近似的，也就是在空间上近似
- 极端情况，假设 $K$ 是单位矩阵，那么所谓的 “相似” 指的就是 “在同一象限”



## 参考资料


- [https://github.com/guofei9987/pyLSHash](https://github.com/guofei9987/pyLSHash)
- [https://github.com/kayzhu/LSHash](https://github.com/kayzhu/LSHash)



## min-hash

MinHash 是什么
- 是LSH的一种，
- 可以用来快速估算两个集合的相似度。
- MinHash由Andrei Broder提出，最初用于在搜索引擎中检测重复网页。它也可以应用于大规模聚类问题。


算法过程
- 输入是一个 01 矩阵，它代表一个集合
- 随机生成 k 种打乱顺序的方法（k种全排列）
- 记录下每种排列下，第 0 个 1 所在的位置
- 得到 k 个数字，它就是 MinHash 值


性质：对于 A，B 集合，MinHash 值相等的概率，等于 Jaccard 相似度

算法问题：如果特征很大，那么全排列非常耗时
算法改进：
- 定理：$h(x) = (ax+b) \mod n$，如果 a和n互素，那么这个函数可以生成全排列，
    - 例如：$h(x) = (3x+1) \mod 5$ 把 `0,1,2,3,4` 映射到 `1,4,2,0,3`
- 算法：遍历，取当前的最小值


min-hash 得到的是 Hash 值，通常还要判断其类别，就接上面的 LSH 算法


参考：https://blog.csdn.net/OrthocenterChocolate/article/details/38943491


## SimHash

是什么：
- 传统 Hash 无法衡量原内容的相似度。如果 Hash 值不相等。只能证明原始内容不完全一样。即使原始内容只相差一个字节，所产生的 Hash 值也很可能差别很大。
- SimHash 作为一种局部敏感哈希算法，它产生的hash值在一定程度上可以表征原内容的相似度。
- SimHash 算法是 Google 公司进行海量网页去重的高效算法
- 它把原始的文本映射为 64 位的二进制，然后用来快速判断其相似度

算法：
- 提取 feature 以及 feature 对应的权重。典型做法：分词、去除停用词，用 TF-IDF 做权重
- Hash：每个词做 Hash
- 加权：对二进制位，1的位置乘以权重，0的位置取负乘以权重
- 合并：把它们加起来
- 降维：如果位置大于0，则设置位1；小于0，则设置位0。得到一串二进制，就是 SimHash 值

检索过程
- 把64位 SimHash 指纹拆成 4 个 16 位
- 倒排索引，类似 `{hash_value: passage_id}`
- 检测过程。根据抽屉原理，最多 3 位不同，必然有一个分片完全相同
- 即可很快检出

参考资料：
- https://github.com/1e0ng/simhash
![SimHash](/pictures_for_blog/algorithm/hash/sim_hash.jpg)

一些使用场景
- Google，不多说
- 网易云，用户的关注情况作为文章，用 SimHash 计算出相似的陌生人 https://zhuanlan.zhihu.com/p/490369474